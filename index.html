<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Congressional Voting System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .session-info {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .session-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .status-indicator {
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
        }

        .status-connected {
            background: #d4edda;
            color: #155724;
        }

        .status-loading {
            background: #fff3cd;
            color: #856404;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-section {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }

        .control-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            flex: 1;
            min-width: 150px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }

        input, select, button {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        input[type="number"] {
            text-align: center;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .chambers-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .chamber-section {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .chamber-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }

        .chamber-title {
            font-size: 1.6em;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }

        .parties-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .party-section {
            border: 2px solid;
            border-radius: 12px;
            padding: 20px;
        }

        .republican-section {
            border-color: #dc3545;
            background: rgba(220, 53, 69, 0.05);
        }

        .democrat-section {
            border-color: #007bff;
            background: rgba(0, 123, 255, 0.05);
        }

        .party-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .party-title {
            font-size: 1.2em;
            font-weight: 700;
        }

        .republican-section .party-title {
            color: #dc3545;
        }

        .democrat-section .party-title {
            color: #007bff;
        }

        .faction-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(255,255,255,0.8);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .faction-item:hover {
            transform: translateX(3px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .faction-info {
            flex: 1;
            margin-right: 10px;
        }

        .faction-name {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .faction-count {
            font-size: 12px;
            color: #666;
        }

        .vote-buttons {
            display: flex;
            gap: 6px;
        }

        .vote-btn {
            width: 40px;
            height: 30px;
            font-size: 11px;
            font-weight: 600;
            border: 2px solid;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 0;
        }

        .vote-btn.aye {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .vote-btn.nay {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .vote-btn.pres {
            background: #ffc107;
            color: #212529;
            border-color: #ffc107;
        }

        .vote-btn:not(.active) {
            background: white;
            color: #666;
        }

        .vote-btn.aye:not(.active) {
            border-color: #28a745;
            color: #28a745;
        }

        .vote-btn.nay:not(.active) {
            border-color: #dc3545;
            color: #dc3545;
        }

        .vote-btn.pres:not(.active) {
            border-color: #ffc107;
            color: #f39c12;
        }

        .vote-btn:hover {
            transform: scale(1.05);
        }

        .results-section {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .chamber-results {
            text-align: center;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid #dee2e6;
        }

        .results-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .rep-row {
            background: rgba(220, 53, 69, 0.1);
        }

        .dem-row {
            background: rgba(0, 123, 255, 0.1);
        }

        .total-row {
            background: #e9ecef;
            font-weight: 600;
        }

        .delete-btn {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #dc3545;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 14px;
            margin-left: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delete-btn:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .add-faction {
            background: rgba(40, 167, 69, 0.1);
            border: 2px dashed #28a745;
            color: #28a745;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s ease;
            font-size: 13px;
        }

        .add-faction:hover {
            background: rgba(40, 167, 69, 0.2);
            transform: translateY(-1px);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 1200px) {
            .chambers-section {
                grid-template-columns: 1fr;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .parties-grid {
                grid-template-columns: 1fr;
            }
            
            .control-row {
                flex-direction: column;
            }
            
            .control-group {
                min-width: 100%;
            }

            .session-info {
                flex-direction: column;
                text-align: center;
            }
        }

        .export-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .clear-btn {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
        }

        .session-btn {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }

        .seat-display {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        🚀 Connecting to database...
    </div>

    <div id="app" class="container" style="display: none;">
        <div class="header">
            <h1>🏛️ Advanced Congressional Voting System</h1>
            <p>Faction-Based Vote Tracking with Customizable Party Compositions</p>
        </div>

        <div class="session-info">
            <div class="session-selector">
                <label for="sessionSelect" style="margin: 0; margin-right: 10px;">Session:</label>
                <select id="sessionSelect" style="width: 200px;" onchange="loadSession(this.value)">
                    <option value="">Select a session...</option>
                </select>
                <button onclick="createNewSession()" class="session-btn" style="width: 150px;">New Session</button>
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <div id="currentSession" style="font-weight: 600; color: #28a745;">
                    No session selected
                </div>
                <div id="connectionStatus" class="status-indicator status-loading">
                    Connecting...
                </div>
            </div>
        </div>

        <div class="controls-grid">
            <div class="control-section">
                <div class="section-title">📊 Party Seat Configuration</div>
                <div class="control-row">
                    <div class="control-group">
                        <label>Republican Senate Seats</label>
                        <input type="number" id="repSenateSeats" value="49" min="0" max="100" onchange="updatePartySeats()">
                    </div>
                    <div class="control-group">
                        <label>Republican House Seats</label>
                        <input type="number" id="repHouseSeats" value="232" min="0" max="435" onchange="updatePartySeats()">
                    </div>
                </div>
                <div class="control-row">
                    <div class="control-group">
                        <label>Democrat Senate Seats</label>
                        <input type="number" id="demSenateSeats" value="50" min="0" max="100" onchange="updatePartySeats()">
                    </div>
                    <div class="control-group">
                        <label>Democrat House Seats</label>
                        <input type="number" id="demHouseSeats" value="203" min="0" max="435" onchange="updatePartySeats()">
                    </div>
                </div>
            </div>

            <div class="control-section">
                <div class="section-title">👥 Add New Faction</div>
                <div class="control-row">
                    <div class="control-group">
                        <label for="factionName">Faction Name</label>
                        <input type="text" id="factionName" placeholder="e.g., Progressive Caucus">
                    </div>
                    <div class="control-group">
                        <label for="factionParty">Party</label>
                        <select id="factionParty">
                            <option value="republican">Republican</option>
                            <option value="democrat">Democrat</option>
                        </select>
                    </div>
                </div>
                <div class="control-row">
                    <div class="control-group">
                        <label for="factionSenateCount">Senate Members</label>
                        <input type="number" id="factionSenateCount" value="0" min="0" max="100">
                    </div>
                    <div class="control-group">
                        <label for="factionHouseCount">House Members</label>
                        <input type="number" id="factionHouseCount" value="0" min="0" max="435">
                    </div>
                </div>
                <button onclick="addFaction()">Add Faction</button>
            </div>
        </div>

        <div class="chambers-section">
            <div class="chamber-section">
                <div class="chamber-header">
                    <div class="chamber-title">🏛️ Senate (Weighted Votes)</div>
                    <div style="font-size: 14px; color: #666;">
                        ⚖️ Weighted by role: Leader 25%, Whip 20%, Caucus Chairs 15%/10%/5%, Senators share remaining 25%
                    </div>
                </div>
                
                <div class="control-row" style="margin-bottom: 20px;">
                    <div class="control-group">
                        <label for="senatorName">Senator Name</label>
                        <input type="text" id="senatorName" placeholder="Enter senator name">
                    </div>
                    <div class="control-group">
                        <label for="senatorParty">Party</label>
                        <select id="senatorParty">
                            <option value="republican">Republican</option>
                            <option value="democrat">Democrat</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="senatorRole">Role</label>
                        <select id="senatorRole">
                            <option value="senator">Senator</option>
                            <option value="party_leader">Party Leader</option>
                            <option value="party_whip">Party Whip</option>
                            <option value="caucus_chair">Caucus Chair</option>
                        </select>
                    </div>
                </div>
                <div class="control-row" style="margin-bottom: 20px;">
                    <div class="control-group">
                        <label for="senatorFaction">Faction</label>
                        <select id="senatorFaction">
                            <option value="">Select faction...</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>&nbsp;</label>
                        <button onclick="addSenator()">Add Senator</button>
                    </div>
                </div>

                <div class="parties-grid">
                    <div class="party-section republican-section">
                        <div class="party-header">
                            <span class="party-title">🔴 Republicans</span>
                        </div>
                        <div class="seat-display">
                            Seats: <span id="repSenateCurrent">0</span> / <span id="repSenateTotal">49</span>
                        </div>
                        <div id="republicanSenators"></div>
                    </div>

                    <div class="party-section democrat-section">
                        <div class="party-header">
                            <span class="party-title">🔵 Democrats</span>
                        </div>
                        <div class="seat-display">
                            Seats: <span id="demSenateCurrent">0</span> / <span id="demSenateTotal">50</span>
                        </div>
                        <div id="democratSenators"></div>
                    </div>
                </div>
            </div>

            <div class="chamber-section">
                <div class="chamber-header">
                    <div class="chamber-title">🏢 House (Faction Votes)</div>
                    <div style="font-size: 14px; color: #666;">
                        ⚠️ House votes by faction - each faction vote = all faction members
                    </div>
                </div>

                <div class="parties-grid">
                    <div class="party-section republican-section">
                        <div class="party-header">
                            <span class="party-title">🔴 Republicans</span>
                        </div>
                        <div class="seat-display">
                            Seats: <span id="repHouseCurrent">0</span> / <span id="repHouseTotal">232</span>
                        </div>
                        <div id="republicanHouseFactions"></div>
                        <div class="add-faction" onclick="showAddFaction('republican')">
                            + Add Republican Faction
                        </div>
                    </div>

                    <div class="party-section democrat-section">
                        <div class="party-header">
                            <span class="party-title">🔵 Democrats</span>
                        </div>
                        <div class="seat-display">
                            Seats: <span id="demHouseCurrent">0</span> / <span id="demHouseTotal">203</span>
                        </div>
                        <div id="democratHouseFactions"></div>
                        <div class="add-faction" onclick="showAddFaction('democrat')">
                            + Add Democrat Faction
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="control-section">
            <div class="control-row">
                <div class="control-group">
                    <button onclick="exportResults()" class="export-btn">Export Results</button>
                </div>
                <div class="control-group">
                    <button onclick="clearAllVotes()" class="clear-btn">Clear All Votes</button>
                </div>
                <div class="control-group">
                    <button onclick="reloadCurrentSession()" class="session-btn">Reload Session</button>
                </div>
            </div>
        </div>

        <div class="results-section">
            <h2 style="text-align: center; margin-bottom: 30px; color: #333;">📈 Voting Results</h2>
            <div class="results-grid">
                <div class="chamber-results">
                    <h3 class="chamber-title">🏛️ Senate Results</h3>
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Party</th>
                                <th>AYE</th>
                                <th>NAY</th>
                                <th>PRESENT</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="rep-row">
                                <td>Republican</td>
                                <td id="repSenateAye">0</td>
                                <td id="repSenateNay">0</td>
                                <td id="repSenatePres">0</td>
                            </tr>
                            <tr class="dem-row">
                                <td>Democrat</td>
                                <td id="demSenateAye">0</td>
                                <td id="demSenateNay">0</td>
                                <td id="demSenatePres">0</td>
                            </tr>
                            <tr class="total-row">
                                <td><strong>TOTAL</strong></td>
                                <td id="totalSenateAye">0</td>
                                <td id="totalSenateNay">0</td>
                                <td id="totalSenatePres">0</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="chamber-results">
                    <h3 class="chamber-title">🏢 House Results</h3>
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Party</th>
                                <th>AYE</th>
                                <th>NAY</th>
                                <th>PRESENT</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="rep-row">
                                <td>Republican</td>
                                <td id="repHouseAye">0</td>
                                <td id="repHouseNay">0</td>
                                <td id="repHousePres">0</td>
                            </tr>
                            <tr class="dem-row">
                                <td>Democrat</td>
                                <td id="demHouseAye">0</td>
                                <td id="demHouseNay">0</td>
                                <td id="demHousePres">0</td>
                            </tr>
                            <tr class="total-row">
                                <td><strong>TOTAL</strong></td>
                                <td id="totalHouseAye">0</td>
                                <td id="totalHouseNay">0</td>
                                <td id="totalHousePres">0</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ===== CONFIGURATION =====
        // Your Supabase credentials
        const SUPABASE_URL = 'https://spjvpxbiwfjjvxvltuot.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwanZweGJpd2ZqanZ4dmx0dW90Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTExNTk5MTYsImV4cCI6MjA2NjczNTkxNn0.vb-VK0klRqcgwQ_6kBC4fs-hezl0P6XxjfODt9DEsck';

        // Initialize Supabase client
        let supabase;
        let currentSessionId = null;
        let factions = { republican: [], democrat: [] };
        let senators = { republican: [], democrat: [] };
        let votes = {};
        let partySeats = {
            republican: { senate: 49, house: 232 },
            democrat: { senate: 50, house: 203 }
        };

        // ===== INITIALIZATION =====
        async function initializeApp() {
            try {
                // Initialize Supabase
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // Test connection
                const { data, error } = await supabase.from('sessions').select('count').limit(1);
                
                if (error) throw error;
                
                updateConnectionStatus('connected');
                await loadSessions();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                
            } catch (error) {
                console.error('Failed to initialize:', error);
                updateConnectionStatus('error');
                document.getElementById('loading').innerHTML = 
                    '❌ Database connection failed. Running in offline mode.<br><button onclick="location.reload()">Retry</button>';
            }
        }

        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.className = 'status-indicator status-' + status;
            
            switch(status) {
                case 'connected':
                    statusEl.textContent = '✅ Connected';
                    break;
                case 'loading':
                    statusEl.textContent = '⏳ Loading...';
                    break;
                case 'error':
                    statusEl.textContent = '❌ Disconnected';
                    break;
            }
        }

        // ===== SESSION MANAGEMENT =====
        async function loadSessions() {
            try {
                const { data, error } = await supabase
                    .from('sessions')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const select = document.getElementById('sessionSelect');
                select.innerHTML = '<option value="">Select a session...</option>';
                
                data.forEach(session => {
                    const option = document.createElement('option');
                    option.value = session.id;
                    option.textContent = `${session.name} (${new Date(session.created_at).toLocaleDateString()})`;
                    select.appendChild(option);
                });
                
                // Auto-select the most recent session
                if (data.length > 0) {
                    select.value = data[0].id;
                    await loadSession(data[0].id);
                }
                
            } catch (error) {
                console.error('Error loading sessions:', error);
                alert('Error loading sessions: ' + error.message);
            }
        }

        async function createNewSession() {
            const name = prompt('Enter session name:');
            if (!name) return;
            
            try {
                const { data, error } = await supabase
                    .from('sessions')
                    .insert([{ name: name }])
                    .select();
                
                if (error) throw error;
                
                await loadSessions();
                document.getElementById('sessionSelect').value = data[0].id;
                await loadSession(data[0].id);
                
            } catch (error) {
                console.error('Error creating session:', error);
                alert('Failed to create session');
            }
        }

        async function loadSession(sessionId) {
            if (!sessionId) {
                console.log('No session ID provided');
                return;
            }
            
            console.log('Loading session:', sessionId);
            currentSessionId = sessionId;
            updateConnectionStatus('loading');
            
            try {
                // Load factions
                const { data: factionData, error: factionError } = await supabase
                    .from('factions')
                    .select('*')
                    .eq('session_id', sessionId);
                
                if (factionError) throw factionError;
                
                // Load senators
                const { data: senatorData, error: senatorError } = await supabase
                    .from('senators')
                    .select('*')
                    .eq('session_id', sessionId);
                
                if (senatorError) throw senatorError;
                
                // Load votes
                const { data: voteData, error: voteError } = await supabase
                    .from('faction_votes')
                    .select('*')
                    .eq('session_id', sessionId);
                
                if (voteError) throw voteError;
                
                // Load party seats
                const { data: partyData, error: partyError } = await supabase
                    .from('party_seats')
                    .select('*')
                    .eq('session_id', sessionId);
                
                if (partyError) throw partyError;
                
                // Organize data
                factions = { republican: [], democrat: [] };
                senators = { republican: [], democrat: [] };
                votes = {};
                
                factionData.forEach(faction => {
                    factions[faction.party].push(faction);
                });
                
                senatorData.forEach(senator => {
                    senators[senator.party].push(senator);
                });
                
                voteData.forEach(vote => {
                    votes[vote.faction_id || vote.senator_id] = vote.vote_type;
                });
                
                // Load party seats if available
                if (partyData.length > 0) {
                    const partySeatsData = partyData[0];
                    partySeats = {
                        republican: { 
                            senate: partySeatsData.rep_senate || 49, 
                            house: partySeatsData.rep_house || 232 
                        },
                        democrat: { 
                            senate: partySeatsData.dem_senate || 50, 
                            house: partySeatsData.dem_house || 203 
                        }
                    };
                    updatePartySeatsDisplay();
                } else {
                    // Set defaults if no party data exists
                    partySeats = {
                        republican: { senate: 49, house: 232 },
                        democrat: { senate: 50, house: 203 }
                    };
                    updatePartySeatsDisplay();
                    savePartySeats(); // Save defaults to database
                }
                
                const sessionName = document.getElementById('sessionSelect').selectedOptions[0].textContent;
                document.getElementById('currentSession').textContent = `Active: ${sessionName}`;
                
                updateFactionSelectors();
                renderAll();
                updateResults();
                updateConnectionStatus('connected');
                
            } catch (error) {
                console.error('Error loading session:', error);
                alert('Error loading session: ' + error.message);
                updateConnectionStatus('error');
            }
        }

        // ===== PARTY SEATS MANAGEMENT =====
        function updatePartySeats() {
            partySeats = {
                republican: {
                    senate: parseInt(document.getElementById('repSenateSeats').value) || 0,
                    house: parseInt(document.getElementById('repHouseSeats').value) || 0
                },
                democrat: {
                    senate: parseInt(document.getElementById('demSenateSeats').value) || 0,
                    house: parseInt(document.getElementById('demHouseSeats').value) || 0
                }
            };
            
            console.log('Updated party seats:', partySeats);
            
            // Update all displays throughout the interface
            updatePartySeatsDisplay();
            updateSeatCounts();
            savePartySeats();
            updateResults();
        }

        function updatePartySeatsDisplay() {
            // Update the input fields (in case called from elsewhere)
            document.getElementById('repSenateSeats').value = partySeats.republican.senate;
            document.getElementById('repHouseSeats').value = partySeats.republican.house;
            document.getElementById('demSenateSeats').value = partySeats.democrat.senate;
            document.getElementById('demHouseSeats').value = partySeats.democrat.house;
            
            // Update the total seat displays in the chamber sections
            document.getElementById('repSenateTotal').textContent = partySeats.republican.senate;
            document.getElementById('repHouseTotal').textContent = partySeats.republican.house;
            document.getElementById('demSenateTotal').textContent = partySeats.democrat.senate;
            document.getElementById('demHouseTotal').textContent = partySeats.democrat.house;
            
            console.log('Updated all party seat displays');
        }

        async function savePartySeats() {
            if (!currentSessionId) return;
            
            try {
                const { error } = await supabase
                    .from('party_seats')
                    .upsert([{
                        session_id: currentSessionId,
                        rep_senate: partySeats.republican.senate,
                        rep_house: partySeats.republican.house,
                        dem_senate: partySeats.democrat.senate,
                        dem_house: partySeats.democrat.house
                    }]);
                
                if (error) throw error;
                
            } catch (error) {
                console.error('Error saving party seats:', error);
            }
        }

        // ===== FACTION MANAGEMENT =====
        async function addFaction() {
            const name = document.getElementById('factionName').value.trim();
            const party = document.getElementById('factionParty').value;
            const senateCount = parseInt(document.getElementById('factionSenateCount').value) || 0;
            const houseCount = parseInt(document.getElementById('factionHouseCount').value) || 0;

            if (!name || !currentSessionId) {
                alert('Please enter a faction name and select a session');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('factions')
                    .insert([{
                        session_id: currentSessionId,
                        name: name,
                        party: party,
                        senate_count: senateCount,
                        house_count: houseCount
                    }])
                    .select();

                if (error) throw error;

                factions[party].push(data[0]);
                document.getElementById('factionName').value = '';
                document.getElementById('factionSenateCount').value = '0';
                document.getElementById('factionHouseCount').value = '0';
                
                updateFactionSelectors();
                renderAll();
                updateResults();

            } catch (error) {
                console.error('Error adding faction:', error);
                alert('Failed to add faction: ' + error.message);
            }
        }

        function showAddFaction(party) {
            document.getElementById('factionParty').value = party;
            document.getElementById('factionName').focus();
        }

        function updateFactionSelectors() {
            const senatorFactionSelect = document.getElementById('senatorFaction');
            senatorFactionSelect.innerHTML = '<option value="">Select faction...</option>';
            
            ['republican', 'democrat'].forEach(party => {
                factions[party].forEach(faction => {
                    const option = document.createElement('option');
                    option.value = faction.id;
                    option.textContent = `${faction.name} (${party.charAt(0).toUpperCase() + party.slice(1)})`;
                    senatorFactionSelect.appendChild(option);
                });
            });
        }

        // ===== SENATOR MANAGEMENT =====
        async function addSenator() {
            const name = document.getElementById('senatorName').value.trim();
            const party = document.getElementById('senatorParty').value;
            const role = document.getElementById('senatorRole').value;
            const factionId = document.getElementById('senatorFaction').value;

            if (!name || !currentSessionId) {
                alert('Please enter a senator name and select a session');
                return;
            }

            // Validate role restrictions
            if (role === 'party_leader' || role === 'party_whip') {
                const existingRoles = senators[party].filter(s => s.role === role);
                if (existingRoles.length > 0) {
                    alert(`There can only be one ${role.replace('_', ' ')} per party. Current ${role.replace('_', ' ')}: ${existingRoles[0].name}`);
                    return;
                }
            }

            try {
                const { data, error } = await supabase
                    .from('senators')
                    .insert([{
                        session_id: currentSessionId,
                        name: name,
                        party: party,
                        role: role,
                        faction_id: factionId || null
                    }])
                    .select();

                if (error) throw error;

                senators[party].push(data[0]);
                document.getElementById('senatorName').value = '';
                
                renderAll();
                updateResults();

            } catch (error) {
                console.error('Error adding senator:', error);
                alert('Failed to add senator: ' + error.message);
            }
        }

        // ===== VOTE WEIGHT CALCULATIONS =====
        function calculateSenatorVoteWeight(senator, party) {
            const partySeats = partySeats[party].senate;
            const partyFactions = factions[party].filter(f => f.senate_count > 0);
            
            // Sort factions by size for caucus chair hierarchy
            const sortedFactions = [...partyFactions].sort((a, b) => b.senate_count - a.senate_count);
            
            switch(senator.role) {
                case 'party_leader':
                    return partySeats * 0.25; // 25%
                case 'party_whip':
                    return partySeats * 0.20; // 20%
                case 'caucus_chair':
                    // Determine caucus chair weight based on faction size ranking
                    const senatorFaction = factions[party].find(f => f.id === senator.faction_id);
                    if (!senatorFaction) return 0;
                    
                    const factionRank = sortedFactions.findIndex(f => f.id === senatorFaction.id);
                    if (factionRank === 0) return partySeats * 0.15; // Largest caucus: 15%
                    if (factionRank === 1) return partySeats * 0.10; // Middle caucus: 10%
                    if (factionRank === 2) return partySeats * 0.05; // Smallest caucus: 5%
                    return 0; // No weight if more than 3 factions
                case 'senator':
                default:
                    // Regular senators share remaining 25% of votes
                    const remainingPercentage = 0.25;
                    const regularSenators = senators[party].filter(s => s.role === 'senator');
                    const senatorFaction = factions[party].find(f => f.id === senator.faction_id);
                    
                    if (!senatorFaction) {
                        // If no faction, share equally among all regular senators in party
                        return (partySeats * remainingPercentage) / regularSenators.length;
                    } else {
                        // Share within faction first, then party
                        const factionRegularSenators = regularSenators.filter(s => s.faction_id === senator.faction_id);
                        const factionWeight = senatorFaction.senate_count / partySeats;
                        return (partySeats * remainingPercentage * factionWeight) / factionRegularSenators.length;
                    }
            }
        }

        function getSenatorDisplayWeight(senator, party) {
            const weight = calculateSenatorVoteWeight(senator, party);
            return Math.round(weight * 100) / 100; // Round to 2 decimal places
        }

        function getRoleDisplayName(role) {
            switch(role) {
                case 'party_leader': return 'Party Leader';
                case 'party_whip': return 'Party Whip';
                case 'caucus_chair': return 'Caucus Chair';
                case 'senator':
                default: return 'Senator';
            }
        }
        async function vote(id, voteType, isSenator = false) {
            if (!currentSessionId) {
                alert('No session selected');
                return;
            }

            console.log('Recording vote:', { id, voteType, isSenator, sessionId: currentSessionId });

            try {
                const table = isSenator ? 'senator_votes' : 'faction_votes';
                const idField = isSenator ? 'senator_id' : 'faction_id';
                
                // Delete existing vote
                await supabase
                    .from(table)
                    .delete()
                    .eq('session_id', currentSessionId)
                    .eq(idField, id);

                // Insert new vote
                const { data, error } = await supabase
                    .from(table)
                    .insert([{
                        session_id: currentSessionId,
                        [idField]: id,
                        vote_type: voteType
                    }])
                    .select();

                if (error) throw error;

                votes[id] = voteType;
                renderAll();
                updateResults();

            } catch (error) {
                console.error('Error recording vote:', error);
                alert('Failed to record vote: ' + error.message);
            }
        }

        // ===== RENDERING =====
        function renderAll() {
            renderSenators();
            renderHouseFactions();
            updateSeatCounts();
        }

        function renderSenators() {
            ['republican', 'democrat'].forEach(party => {
                const container = document.getElementById(party === 'republican' ? 'republicanSenators' : 'democratSenators');
                
                // Sort senators by role hierarchy for display
                const sortedSenators = [...senators[party]].sort((a, b) => {
                    const roleOrder = { 'party_leader': 0, 'party_whip': 1, 'caucus_chair': 2, 'senator': 3 };
                    return roleOrder[a.role] - roleOrder[b.role];
                });
                
                container.innerHTML = sortedSenators.map(senator => {
                    const faction = factions[party].find(f => f.id === senator.faction_id);
                    const factionName = faction ? faction.name : 'No Faction';
                    const roleDisplay = getRoleDisplayName(senator.role);
                    const voteWeight = getSenatorDisplayWeight(senator, party);
                    
                    return `
                        <div class="faction-item">
                            <div class="faction-info">
                                <div class="faction-name">${senator.name}</div>
                                <div class="faction-count">
                                    ${roleDisplay} | ${factionName} | Weight: ${voteWeight} votes
                                </div>
                            </div>
                            <div class="vote-buttons">
                                <button class="vote-btn aye ${votes[senator.id] === 'aye' ? 'active' : ''}" 
                                        onclick="console.log('Senate vote: ${senator.name} (${voteWeight} votes)'); vote(${senator.id}, 'aye', true)">AYE</button>
                                <button class="vote-btn nay ${votes[senator.id] === 'nay' ? 'active' : ''}" 
                                        onclick="console.log('Senate vote: ${senator.name} (${voteWeight} votes)'); vote(${senator.id}, 'nay', true)">NAY</button>
                                <button class="vote-btn pres ${votes[senator.id] === 'pres' ? 'active' : ''}" 
                                        onclick="console.log('Senate vote: ${senator.name} (${voteWeight} votes)'); vote(${senator.id}, 'pres', true)">PRES</button>
                            </div>
                            <button class="delete-btn" onclick="removeSenator('${party}', ${senator.id})">×</button>
                        </div>
                    `;
                }).join('');
            });
        }

        function renderHouseFactions() {
            ['republican', 'democrat'].forEach(party => {
                const container = document.getElementById(party === 'republican' ? 'republicanHouseFactions' : 'democratHouseFactions');
                
                container.innerHTML = factions[party].filter(f => f.house_count > 0).map(faction => `
                    <div class="faction-item">
                        <div class="faction-info">
                            <div class="faction-name">${faction.name}</div>
                            <div class="faction-count">${faction.house_count} House members</div>
                        </div>
                        <div class="vote-buttons">
                            <button class="vote-btn aye ${votes[faction.id] === 'aye' ? 'active' : ''}" 
                                    onclick="console.log('House faction vote: ${faction.name} (${faction.house_count} members)'); vote(${faction.id}, 'aye', false)">AYE</button>
                            <button class="vote-btn nay ${votes[faction.id] === 'nay' ? 'active' : ''}" 
                                    onclick="console.log('House faction vote: ${faction.name} (${faction.house_count} members)'); vote(${faction.id}, 'nay', false)">NAY</button>
                            <button class="vote-btn pres ${votes[faction.id] === 'pres' ? 'active' : ''}" 
                                    onclick="console.log('House faction vote: ${faction.name} (${faction.house_count} members)'); vote(${faction.id}, 'pres', false)">PRES</button>
                        </div>
                        <button class="delete-btn" onclick="removeFaction('${party}', ${faction.id})">×</button>
                    </div>
                `).join('');
            });
        }

        function updateSeatCounts() {
            // Count current senators (for Senate)
            const repSenateCurrent = senators.republican.length;
            const demSenateCurrent = senators.democrat.length;
            
            // Count current faction members (for House)
            const repHouseCurrent = factions.republican.reduce((sum, f) => sum + (f.house_count || 0), 0);
            const demHouseCurrent = factions.democrat.reduce((sum, f) => sum + (f.house_count || 0), 0);

            // Update current count displays
            document.getElementById('repSenateCurrent').textContent = repSenateCurrent;
            document.getElementById('demSenateCurrent').textContent = demSenateCurrent;
            document.getElementById('repHouseCurrent').textContent = repHouseCurrent;
            document.getElementById('demHouseCurrent').textContent = demHouseCurrent;
            
            // Update total count displays (from party seats configuration)
            document.getElementById('repSenateTotal').textContent = partySeats.republican.senate;
            document.getElementById('repHouseTotal').textContent = partySeats.republican.house;
            document.getElementById('demSenateTotal').textContent = partySeats.democrat.senate;
            document.getElementById('demHouseTotal').textContent = partySeats.democrat.house;
            
            console.log('Seat counts updated:', {
                repSenate: `${repSenateCurrent}/${partySeats.republican.senate}`,
                demSenate: `${demSenateCurrent}/${partySeats.democrat.senate}`,
                repHouse: `${repHouseCurrent}/${partySeats.republican.house}`,
                demHouse: `${demHouseCurrent}/${partySeats.democrat.house}`
            });
        }

        // ===== CALCULATIONS =====
        function calculateResults() {
            const results = {
                republican: { senate: { aye: 0, nay: 0, pres: 0 }, house: { aye: 0, nay: 0, pres: 0 } },
                democrat: { senate: { aye: 0, nay: 0, pres: 0 }, house: { aye: 0, nay: 0, pres: 0 } }
            };

            // Calculate Senate results using WEIGHTED votes from senators
            ['republican', 'democrat'].forEach(party => {
                senators[party].forEach(senator => {
                    const vote = votes[senator.id];
                    if (vote) {
                        const weight = calculateSenatorVoteWeight(senator, party);
                        results[party].senate[vote] += weight;
                    }
                });
            });

            // Calculate House results ONLY from factions (never from senators)
            ['republican', 'democrat'].forEach(party => {
                factions[party].forEach(faction => {
                    const vote = votes[faction.id];
                    if (vote && faction.house_count > 0) {
                        results[party].house[vote] += faction.house_count;
                    }
                });
            });

            // Round Senate results to nearest whole number for display
            ['republican', 'democrat'].forEach(party => {
                ['aye', 'nay', 'pres'].forEach(voteType => {
                    results[party].senate[voteType] = Math.round(results[party].senate[voteType]);
                });
            });

            return results;
        }

        function updateResults() {
            const results = calculateResults();
            
            // Update Senate results
            document.getElementById('repSenateAye').textContent = results.republican.senate.aye;
            document.getElementById('repSenateNay').textContent = results.republican.senate.nay;
            document.getElementById('repSenatePres').textContent = results.republican.senate.pres;
            
            document.getElementById('demSenateAye').textContent = results.democrat.senate.aye;
            document.getElementById('demSenateNay').textContent = results.democrat.senate.nay;
            document.getElementById('demSenatePres').textContent = results.democrat.senate.pres;
            
            document.getElementById('totalSenateAye').textContent = 
                results.republican.senate.aye + results.democrat.senate.aye;
            document.getElementById('totalSenateNay').textContent = 
                results.republican.senate.nay + results.democrat.senate.nay;
            document.getElementById('totalSenatePres').textContent = 
                results.republican.senate.pres + results.democrat.senate.pres;

            // Update House results
            document.getElementById('repHouseAye').textContent = results.republican.house.aye;
            document.getElementById('repHouseNay').textContent = results.republican.house.nay;
            document.getElementById('repHousePres').textContent = results.republican.house.pres;
            
            document.getElementById('demHouseAye').textContent = results.democrat.house.aye;
            document.getElementById('demHouseNay').textContent = results.democrat.house.nay;
            document.getElementById('demHousePres').textContent = results.democrat.house.pres;
            
            document.getElementById('totalHouseAye').textContent = 
                results.republican.house.aye + results.democrat.house.aye;
            document.getElementById('totalHouseNay').textContent = 
                results.republican.house.nay + results.democrat.house.nay;
            document.getElementById('totalHousePres').textContent = 
                results.republican.house.pres + results.democrat.house.pres;
        }

        // ===== DELETION FUNCTIONS =====
        async function removeFaction(party, id) {
            try {
                await supabase.from('factions').delete().eq('id', id);
                factions[party] = factions[party].filter(f => f.id !== id);
                delete votes[id];
                updateFactionSelectors();
                renderAll();
                updateResults();
            } catch (error) {
                console.error('Error removing faction:', error);
                alert('Failed to remove faction: ' + error.message);
            }
        }

        async function removeSenator(party, id) {
            try {
                await supabase.from('senators').delete().eq('id', id);
                senators[party] = senators[party].filter(s => s.id !== id);
                delete votes[id];
                renderAll();
                updateResults();
            } catch (error) {
                console.error('Error removing senator:', error);
                alert('Failed to remove senator: ' + error.message);
            }
        }

        // ===== UTILITY FUNCTIONS =====
        async function clearAllVotes() {
            if (!confirm('Are you sure you want to clear all votes?')) return;
            
            if (!currentSessionId) {
                alert('No session selected');
                return;
            }

            try {
                await supabase.from('faction_votes').delete().eq('session_id', currentSessionId);
                await supabase.from('senator_votes').delete().eq('session_id', currentSessionId);
                
                votes = {};
                renderAll();
                updateResults();

            } catch (error) {
                console.error('Error clearing votes:', error);
                alert('Failed to clear votes: ' + error.message);
            }
        }

        async function reloadCurrentSession() {
            if (currentSessionId) {
                await loadSession(currentSessionId);
            } else {
                alert('No session currently selected');
            }
        }

        async function exportResults() {
            if (!currentSessionId) {
                alert('Please select a session first');
                return;
            }

            const results = calculateResults();
            const exportData = {
                session_id: currentSessionId,
                timestamp: new Date().toISOString(),
                party_seats: partySeats,
                factions: factions,
                senators: senators,
                votes: votes,
                results: results
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `voting_results_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Initialize the application
        initializeApp();
    </script>
</body>
</html>
