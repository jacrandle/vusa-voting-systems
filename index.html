<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Advanced Congressional Voting System</title>

  <!-- 1) Define your Google keys & startup callbacks BEFORE loading api.js -->
  <script>
    // ===== GOOGLE SHEETS CONFIGURATION =====
    const API_KEY = 'AIzaSyBG7opndMaMpXBXEuSv2WmbHfCq9bdZCtk';
    const CLIENT_ID = '790060690197-bst9vs10pu526kqup00jh8rk6kmufp2c.apps.googleusercontent.com';
    const SPREADSHEET_ID = '1_pzZhH-0rkspeX8EeRM_F10K7GIBbOTSnQWXNaXNFew';
    const DISCOVERY_DOCS = ['https://sheets.googleapis.com/$discovery/rest?version=v4'];
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;

    // ‚îÄ‚îÄ‚îÄ 1) Load gapi.client ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function gapiLoaded() {
      console.log('‚úÖ gapi.js loaded, initializing client...');
      gapi.load('client', async () => {
        try {
          await gapi.client.init({
            apiKey: API_KEY,
            discoveryDocs: DISCOVERY_DOCS
          });
          console.log('‚úÖ gapi.client initialized');
          gapiInited = true;
          maybeEnableAuth();
        } catch (error) {
          console.error('‚ùå gapi.client.init failed:', error);
          startMyAppOffline();
        }
      });
    }

    // ‚îÄ‚îÄ‚îÄ 2) Load Google Identity Services ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function gisLoaded() {
      console.log('‚úÖ Google Identity Services loaded');
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (tokenResponse) => {
          if (tokenResponse.error) {
            console.error('‚ùå Token error:', tokenResponse);
            startMyAppOffline();
            return;
          }
          console.log('‚úÖ OAuth2 token received');
          startMyApp();
        }
      });
      gisInited = true;
      maybeEnableAuth();
    }

    // ‚îÄ‚îÄ‚îÄ 3) Check if both APIs are ready ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function maybeEnableAuth() {
      if (gapiInited && gisInited) {
        console.log('‚úÖ Both APIs ready, checking if user needs to authorize...');
        updateAuthUI();
        // Auto-start authorization for seamless experience
        handleAuthClick();
      }
    }

    // ‚îÄ‚îÄ‚îÄ 4) Click to authorize ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function handleAuthClick() {
      console.log('üîë Requesting authorization...');
      const detailsEl = document.getElementById('connectionDetails');
      if (detailsEl) detailsEl.textContent = 'Requesting Google authorization...';
      
      // Request an access token
      tokenClient.requestAccessToken({ prompt: 'consent' });
    }

    // ‚îÄ‚îÄ‚îÄ 5) Sign out ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function handleSignoutClick() {
      try {
        const token = gapi && gapi.client && gapi.client.getToken();
        if (token !== null) {
          google.accounts.oauth2.revoke(token.access_token);
          gapi.client.setToken('');
          console.log('‚úÖ Signed out');
          updateAuthUI();
          startMyAppOffline();
        }
      } catch (error) {
        console.error('Error during sign out:', error);
        // Force a refresh to clear any cached state
        location.reload();
      }
    }

    // ‚îÄ‚îÄ‚îÄ 6) Update UI based on auth status ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function updateAuthUI() {
      const signInBtn = document.getElementById('authorizeBtn');
      const signOutBtn = document.getElementById('signoutBtn');
      const authStatus = document.getElementById('authStatus');
      
      try {
        const isAuthorized = gapi && gapi.client && gapi.client.getToken() !== null;
        
        if (isAuthorized) {
          if (signInBtn) signInBtn.style.display = 'none';
          if (signOutBtn) signOutBtn.style.display = 'inline-block';
          if (authStatus) authStatus.textContent = '‚úÖ Authorized';
        } else {
          if (signInBtn) signInBtn.style.display = 'inline-block';
          if (signOutBtn) signOutBtn.style.display = 'none';
          if (authStatus) authStatus.textContent = 'üîë Authorization required';
        }
      } catch (error) {
        // If there's any error checking auth status, show as not authorized
        if (signInBtn) signInBtn.style.display = 'inline-block';
        if (signOutBtn) signOutBtn.style.display = 'none';
        if (authStatus) authStatus.textContent = 'üîë Authorization required';
      }
    }

    // ============ Your two entrypoints ==============
    async function startMyApp() {
      try {
        const isAuthorized = gapi && gapi.client && gapi.client.getToken() !== null;
        if (!isAuthorized) {
          console.log('‚ö†Ô∏è Not authorized, cannot start Google Sheets mode');
          startMyAppOffline();
          return;
        }

        console.log('üöÄ Starting with Google Sheets connection‚Ä¶');
        syncEnabled = true;
        updateSyncStatus('syncing');
        const detailsEl = document.getElementById('connectionDetails');
        if (detailsEl) detailsEl.textContent = 'Testing Google Sheets connection‚Ä¶';

        // Test metadata - uses the OAuth2 token automatically
        const resp = await gapi.client.sheets.spreadsheets.get({ spreadsheetId: SPREADSHEET_ID });
        if (!resp.result) throw new Error('Cannot access spreadsheet.');
        console.log('‚úÖ Google Sheets connected:', resp.result.properties.title);

        await initializeSheetStructure();
        await loadAvailableSessions();
        updateSyncStatus('synced');
        updateAuthUI();
        if (currentSessionId) await loadSessionFromSheets(currentSessionId);
        updateSessionSelector();
        console.log('‚úÖ Google Sheets mode ready!');
      }
      catch (err) {
        console.error('‚ùå Google Sheets access error:', err);
        const detailsEl = document.getElementById('connectionDetails');
        if (detailsEl) {
          if (err.status === 403) detailsEl.textContent = 'Permission denied ‚Äì check share settings.';
          else if (err.status === 404) detailsEl.textContent = 'Spreadsheet not found ‚Äì check ID.';
          else if (err.message && err.message.includes('API key')) detailsEl.textContent = 'Invalid API key.';
          else detailsEl.textContent = 'Google Sheets error: ' + (err.message || err);
        }
        startMyAppOffline();
      }
    }

    async function startMyAppOffline() {
      console.log('üìÅ Starting in offline mode‚Ä¶');
      syncEnabled = false;
      updateSyncStatus('offline');
      updateAuthUI();
      const detailsEl = document.getElementById('connectionDetails');
      if (detailsEl) detailsEl.textContent = 'Using enhanced local storage with file backup';

      availableSessions = await loadLocalSessions();
      if (availableSessions.length === 0) {
        availableSessions = [{ id: 'local', name: 'Local Session' }];
        currentSessionId = 'local';
      } else {
        currentSessionId = availableSessions[0].id;
      }
      await loadLocalData();
      updateSessionSelector();
      console.log('‚úÖ Offline mode ready!');
    }

    // Global state
    let currentSessionId = null;
    let availableSessions = [];
    let factions = { republican: [], democrat: [] };
    let senators = { republican: [], democrat: [] };
    let votes = {};
    let partySeats = {
      republican: { senate: 49, house: 232 },
      democrat:   { senate: 50, house: 203 }
    };
    let syncEnabled = false;
    let isOnline = navigator.onLine;
  </script>

  <!-- Load Google Identity Services -->
  <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
  <!-- Load gapi.client -->
  <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>

  <!-- 3) Your CSS -->
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      color: white;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .header p {
      font-size: 1.1em;
      opacity: 0.9;
    }

    .sync-info {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .sync-selector {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .session-selector {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .session-selector select {
      padding: 8px 12px;
      border: 2px solid #e1e5e9;
      border-radius: 6px;
      background: white;
    }

    .session-selector button {
      padding: 8px 12px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
    }

    .status-indicator {
      padding: 8px 12px;
      border-radius: 6px;
      font-weight: 600;
      font-size: 14px;
    }

    .status-local {
      background: #e1f5fe;
      color: #01579b;
    }

    .status-syncing {
      background: #fff3e0;
      color: #e65100;
    }

    .status-synced {
      background: #e8f5e8;
      color: #2e7d32;
    }

    .status-offline {
      background: #fce4ec;
      color: #ad1457;
    }

    .controls-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }

    .control-section {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }

    .section-title {
      font-size: 1.3em;
      font-weight: 700;
      margin-bottom: 15px;
      color: #333;
      border-bottom: 2px solid #e9ecef;
      padding-bottom: 10px;
    }

    .control-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      flex-wrap: wrap;
      align-items: center;
    }

    .control-group {
      flex: 1;
      min-width: 150px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #555;
      font-size: 14px;
    }

    input, select, button {
      width: 100%;
      padding: 10px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    input[type="number"] {
      text-align: center;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .chambers-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 30px;
    }

    .chamber-section {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }

    .chamber-header {
      text-align: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 3px solid #667eea;
    }

    .chamber-title {
      font-size: 1.6em;
      font-weight: 700;
      color: #333;
      margin-bottom: 10px;
    }

    .parties-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .party-section {
      border: 2px solid;
      border-radius: 12px;
      padding: 20px;
    }

    .republican-section {
      border-color: #dc3545;
      background: rgba(220, 53, 69, 0.05);
    }

    .democrat-section {
      border-color: #007bff;
      background: rgba(0, 123, 255, 0.05);
    }

    .party-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .party-title {
      font-size: 1.2em;
      font-weight: 700;
    }

    .republican-section .party-title {
      color: #dc3545;
    }

    .democrat-section .party-title {
      color: #007bff;
    }

    .faction-item {
      display: flex;
      align-items: center;
      padding: 10px;
      margin-bottom: 8px;
      background: rgba(255,255,255,0.8);
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .faction-item:hover {
      transform: translateX(3px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .faction-info {
      flex: 1;
      margin-right: 10px;
    }

    .faction-name {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .faction-count {
      font-size: 12px;
      color: #666;
    }

    .vote-buttons {
      display: flex;
      gap: 6px;
    }

    .vote-btn {
      width: 40px;
      height: 30px;
      font-size: 11px;
      font-weight: 600;
      border: 2px solid;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
      padding: 0;
    }

    .vote-btn.aye {
      background: #28a745;
      color: white;
      border-color: #28a745;
    }

    .vote-btn.nay {
      background: #dc3545;
      color: white;
      border-color: #dc3545;
    }

    .vote-btn.pres {
      background: #ffc107;
      color: #212529;
      border-color: #ffc107;
    }

    .vote-btn:not(.active) {
      background: white;
      color: #666;
    }

    .vote-btn.aye:not(.active) {
      border-color: #28a745;
      color: #28a745;
    }

    .vote-btn.nay:not(.active) {
      border-color: #dc3545;
      color: #dc3545;
    }

    .vote-btn.pres:not(.active) {
      border-color: #ffc107;
      color: #f39c12;
    }

    .vote-btn:hover {
      transform: scale(1.05);
    }

    .results-section {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }

    .results-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }

    .chamber-results {
      text-align: center;
    }

    .results-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
    }

    .results-table th,
    .results-table td {
      padding: 12px;
      text-align: center;
      border: 1px solid #dee2e6;
    }

    .results-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #495057;
    }

    .rep-row {
      background: rgba(220, 53, 69, 0.1);
    }

    .dem-row {
      background: rgba(0, 123, 255, 0.1);
    }

    .total-row {
      background: #e9ecef;
      font-weight: 600;
    }

    .delete-btn {
      width: 25px;
      height: 25px;
      border-radius: 50%;
      background: #dc3545;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 14px;
      margin-left: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .delete-btn:hover {
      background: #c82333;
      transform: scale(1.1);
    }

    .add-faction {
      background: rgba(40, 167, 69, 0.1);
      border: 2px dashed #28a745;
      color: #28a745;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
      transition: all 0.3s ease;
      font-size: 13px;
    }

    .add-faction:hover {
      background: rgba(40, 167, 69, 0.2);
      transform: translateY(-1px);
    }

    .seat-display {
      background: #f8f9fa;
      padding: 8px 12px;
      border-radius: 6px;
      font-weight: 600;
      text-align: center;
      margin-bottom: 10px;
    }

    @media (max-width: 1200px) {
      .chambers-section {
        grid-template-columns: 1fr;
      }
      
      .results-grid {
        grid-template-columns: 1fr;
      }
      
      .controls-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .parties-grid {
        grid-template-columns: 1fr;
      }
      
      .control-row {
        flex-direction: column;
      }
      
      .control-group {
        min-width: 100%;
      }

      .sync-info {
        flex-direction: column;
        text-align: center;
      }
    }

    .export-btn {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }

    .clear-btn {
      background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
    }

    .sync-btn {
      background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
    }

    .faction-group {
      margin-bottom: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 12px;
      background: rgba(255,255,255,0.5);
    }

    .faction-group-header {
      font-weight: 700;
      margin-bottom: 8px;
      color: #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .faction-count-badge {
      font-size: 12px;
      background: #f8f9fa;
      padding: 2px 8px;
      border-radius: 12px;
      font-weight: 500;
    }

    .unassigned-group {
      margin-bottom: 20px;
      border: 1px dashed #ccc;
      border-radius: 8px;
      padding: 12px;
      background: rgba(255,255,255,0.3);
    }

    .unassigned-group-header {
      font-weight: 700;
      margin-bottom: 8px;
      color: #666;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .hastert-section {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border: 2px solid #dee2e6;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .hastert-title {
      font-size: 1.2em;
      font-weight: 700;
      color: #333;
      margin-bottom: 15px;
      text-align: center;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }

    .hastert-content {
      font-size: 14px;
      line-height: 1.5;
    }

    .hastert-satisfied {
      background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
      color: #155724;
      border: 2px solid #28a745;
      padding: 12px;
      border-radius: 8px;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
    }

    .hastert-not-met {
      background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
      color: #721c24;
      border: 2px solid #dc3545;
      padding: 12px;
      border-radius: 8px;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 2px 8px rgba(220, 53, 69, 0.2);
    }

    .bill-status-passing {
      background: linear-gradient(135deg, #cce5ff 0%, #b3d9ff 100%);
      color: #0066cc;
      border: 2px solid #007bff;
      padding: 8px;
      border-radius: 6px;
      margin-top: 8px;
      font-size: 13px;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0, 123, 255, 0.2);
    }

    .bill-status-failing {
      background: linear-gradient(135deg, #ffe6e6 0%, #ffcccc 100%);
      color: #cc0000;
      border: 2px solid #dc3545;
      padding: 8px;
      border-radius: 6px;
      margin-top: 8px;
      font-size: 13px;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 2px 6px rgba(220, 53, 69, 0.2);
    }
  </style>
</head>

<body>
  <!-- ==== Your HTML markup ==== -->
  <div class="container">
    <div class="header">
      <h1>üèõÔ∏è Advanced Congressional Voting System</h1>
      <p>Now powered by Google Sheets ‚Äì Real-time collaboration!</p>
      <div style="background:rgba(255,255,255,.2);padding:15px;border-radius:8px;margin-top:10px;font-size:.9em;line-height:1.4">
        <strong>üìã Current Status:</strong><br/>
        ‚úÖ <strong>Spreadsheet Connected:</strong>
        <a href="https://docs.google.com/spreadsheets/d/1_pzZhH-0rkspeX8EeRM_F10K7GIBbOTSnQWXNaXNFew/edit"
           target="_blank" style="color:#fff;text-decoration:underline">
          Your Google Sheet
        </a><br/>
        ‚úÖ <strong>OAuth2 Client ID:</strong> Configured and ready<br/>
        üîÑ <strong>Modern Flow:</strong> Google Identity + gapi hybrid authentication<br/>
        üöÄ <strong>Ready to test!</strong> Serve via http://localhost (not file://)
      </div>
    </div>

    <div class="sync-info">
      <div class="sync-selector">
        <div class="session-selector">
          <strong>Session:</strong>
          <select id="sessionSelect" onchange="switchSession()">
            <option value="default">Default Session</option>
            <option value="scenario-1">Scenario 1</option>
            <option value="scenario-2">Scenario 2</option>
            <option value="custom">Custom Session</option>
          </select>
          <button onclick="createNewSession()">New</button>
          <button onclick="importAllData()" title="Import from file">üìÅ‚Üë</button>
          <button onclick="exportAllData()" title="Export to file">üìÅ‚Üì</button>
        </div>
        <div>
          <strong>Status:</strong> <span id="connectionDetails">Initializing...</span><br>
          <strong>Auth:</strong> <span id="authStatus">üîë Loading...</span>
        </div>
      </div>
      <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
        <button id="authorizeBtn" onclick="handleAuthClick()" class="sync-btn" style="width: 120px; display: none;">
          üîë Authorize
        </button>
        <button id="signoutBtn" onclick="handleSignoutClick()" class="clear-btn" style="width: 120px; display: none;">
          Sign Out
        </button>
        <button onclick="syncWithDatabase()" class="sync-btn" style="width: 120px;" id="syncBtn">
          Sync Now
        </button>
        <div id="syncStatus" class="status-indicator status-local">
          üì± Local Mode
        </div>
      </div>
    </div>

    <div class="controls-grid">
      <div class="control-section">
        <div class="section-title">üìä Party Seat Configuration</div>
        <div class="control-row">
          <div class="control-group">
            <label>Republican Senate Seats</label>
            <input type="number" id="repSenateSeats" value="49" min="0" max="100" onchange="updatePartySeats()">
          </div>
          <div class="control-group">
            <label>Republican House Seats</label>
            <input type="number" id="repHouseSeats" value="232" min="0" max="435" onchange="updatePartySeats()">
          </div>
        </div>
        <div class="control-row">
          <div class="control-group">
            <label>Democrat Senate Seats</label>
            <input type="number" id="demSenateSeats" value="50" min="0" max="100" onchange="updatePartySeats()">
          </div>
          <div class="control-group">
            <label>Democrat House Seats</label>
            <input type="number" id="demHouseSeats" value="203" min="0" max="435" onchange="updatePartySeats()">
          </div>
        </div>
      </div>

      <div class="control-section">
        <div class="section-title">üë• Add New Faction</div>
        <div class="control-row">
          <div class="control-group">
            <label for="factionName">Faction Name</label>
            <input type="text" id="factionName" placeholder="e.g., Progressive Caucus">
          </div>
          <div class="control-group">
            <label for="factionParty">Party</label>
            <select id="factionParty">
              <option value="republican">Republican</option>
              <option value="democrat">Democrat</option>
            </select>
          </div>
        </div>
        <div class="control-row">
          <div class="control-group">
            <label for="factionSenateCount">Senate Members</label>
            <input type="number" id="factionSenateCount" value="0" min="0" max="100">
          </div>
          <div class="control-group">
            <label for="factionHouseCount">House Members</label>
            <input type="number" id="factionHouseCount" value="0" min="0" max="435">
          </div>
        </div>
        <button onclick="addFaction()">Add Faction</button>
      </div>
    </div>

    <div class="chambers-section">
      <div class="chamber-section">
        <div class="chamber-header">
          <div class="chamber-title">üèõÔ∏è Senate (Weighted Votes)</div>
          <div style="font-size: 14px; color: #666;">
            ‚öñÔ∏è Constrained weighted voting: Base faction weight + leadership bonus, scaled to never exceed party seat total
          </div>
        </div>
        
        <div class="control-row" style="margin-bottom: 20px;">
          <div class="control-group">
            <label for="senatorName">Senator Name</label>
            <input type="text" id="senatorName" placeholder="Enter senator name">
          </div>
          <div class="control-group">
            <label for="senatorParty">Party</label>
            <select id="senatorParty">
              <option value="republican">Republican</option>
              <option value="democrat">Democrat</option>
            </select>
          </div>
          <div class="control-group">
            <label for="senatorRole">Roles (hold Ctrl/Cmd for multiple)</label>
            <select id="senatorRole" multiple style="height: 80px;">
              <option value="senator">Senator</option>
              <option value="party_leader">Party Leader</option>
              <option value="party_whip">Party Whip</option>
              <option value="caucus_chair">Caucus Chair</option>
            </select>
          </div>
        </div>
        <div class="control-row" style="margin-bottom: 20px;">
          <div class="control-group">
            <label for="senatorFaction">Faction</label>
            <select id="senatorFaction">
              <option value="">Select faction...</option>
            </select>
          </div>
          <div class="control-group">
            <label>&nbsp;</label>
            <button onclick="addSenator()">Add Senator</button>
          </div>
        </div>
        
        <div class="control-row" style="margin-bottom: 20px; border-top: 2px solid #e9ecef; padding-top: 15px;">
          <div class="control-group">
            <label for="bulkSenators">Bulk Add Senators (one per line)</label>
            <textarea id="bulkSenators" placeholder="John Smith (R-TX)&#10;Jane Doe (D-CA)&#10;..." style="height: 100px; resize: vertical;"></textarea>
          </div>
          <div class="control-group">
            <label for="bulkParty">Default Party</label>
            <select id="bulkParty">
              <option value="republican">Republican</option>
              <option value="democrat">Democrat</option>
            </select>
          </div>
        </div>
        <div class="control-row">
          <div class="control-group">
            <label for="bulkFaction">Default Faction</label>
            <select id="bulkFaction">
              <option value="">No faction</option>
            </select>
          </div>
          <div class="control-group">
            <label>&nbsp;</label>
            <button onclick="addBulkSenators()">Add All Senators</button>
          </div>
        </div>

        <div class="parties-grid">
          <div class="party-section republican-section">
            <div class="party-header">
              <span class="party-title">üî¥ Republicans</span>
            </div>
            <div class="seat-display">
              Senators: <span id="repSenateCurrent">0</span> / <span id="repSenateTotal">49</span>
              <br><small>Total Weight: <span id="repSenateWeight">0</span></small>
            </div>
            <div id="republicanSenators"></div>
          </div>

          <div class="party-section democrat-section">
            <div class="party-header">
              <span class="party-title">üîµ Democrats</span>
            </div>
            <div class="seat-display">
              Senators: <span id="demSenateCurrent">0</span> / <span id="demSenateTotal">50</span>
              <br><small>Total Weight: <span id="demSenateWeight">0</span></small>
            </div>
            <div id="democratSenators"></div>
          </div>
        </div>
      </div>

      <div class="chamber-section">
        <div class="chamber-header">
          <div class="chamber-title">üè¢ House (Faction Votes)</div>
          <div style="font-size: 14px; color: #666;">
            ‚ö†Ô∏è House votes by faction - each faction vote = all faction members<br>
            üìè <strong>Hastert Rule:</strong> Majority party must provide majority of their own votes for bill to proceed
          </div>
        </div>

        <div class="parties-grid">
          <div class="party-section republican-section">
            <div class="party-header">
              <span class="party-title">üî¥ Republicans</span>
            </div>
            <div class="seat-display">
              Seats: <span id="repHouseCurrent">0</span> / <span id="repHouseTotal">232</span>
            </div>
            <div id="republicanHouseFactions"></div>
            <div class="add-faction" onclick="showAddFaction('republican')">
              + Add Republican Faction
            </div>
          </div>

          <div class="party-section democrat-section">
            <div class="party-header">
              <span class="party-title">üîµ Democrats</span>
            </div>
            <div class="seat-display">
              Seats: <span id="demHouseCurrent">0</span> / <span id="demHouseTotal">203</span>
            </div>
            <div id="democratHouseFactions"></div>
            <div class="add-faction" onclick="showAddFaction('democrat')">
              + Add Democrat Faction
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="control-section">
      <div class="control-row">
        <div class="control-group">
          <button onclick="exportResults()" class="export-btn">Export Results</button>
        </div>
        <div class="control-group">
          <button onclick="clearAllVotes()" class="clear-btn">Clear All Votes</button>
        </div>
        <div class="control-group">
          <button onclick="resetToDefaults()" class="sync-btn">Reset to Defaults</button>
        </div>
      </div>
    </div>

    <div class="results-section">
      <h2 style="text-align: center; margin-bottom: 30px; color: #333;">üìà Voting Results</h2>
      <div class="results-grid">
        <div class="chamber-results">
          <h3 class="chamber-title">üèõÔ∏è Senate Results</h3>
          <table class="results-table">
            <thead>
              <tr>
                <th>Party</th>
                <th>AYE</th>
                <th>NAY</th>
                <th>PRESENT</th>
              </tr>
            </thead>
            <tbody>
              <tr class="rep-row">
                <td>Republican</td>
                <td id="repSenateAye">0</td>
                <td id="repSenateNay">0</td>
                <td id="repSenatePres">0</td>
              </tr>
              <tr class="dem-row">
                <td>Democrat</td>
                <td id="demSenateAye">0</td>
                <td id="demSenateNay">0</td>
                <td id="demSenatePres">0</td>
              </tr>
              <tr class="total-row">
                <td><strong>TOTAL</strong></td>
                <td id="totalSenateAye">0</td>
                <td id="totalSenateNay">0</td>
                <td id="totalSenatePres">0</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="chamber-results">
          <h3 class="chamber-title">üè¢ House Results</h3>
          <table class="results-table">
            <thead>
              <tr>
                <th>Party</th>
                <th>AYE</th>
                <th>NAY</th>
                <th>PRESENT</th>
              </tr>
            </thead>
            <tbody>
              <tr class="rep-row">
                <td>Republican</td>
                <td id="repHouseAye">0</td>
                <td id="repHouseNay">0</td>
                <td id="repHousePres">0</td>
              </tr>
              <tr class="dem-row">
                <td>Democrat</td>
                <td id="demHouseAye">0</td>
                <td id="demHouseNay">0</td>
                <td id="demHousePres">0</td>
              </tr>
              <tr class="total-row">
                <td><strong>TOTAL</strong></td>
                <td id="totalHouseAye">0</td>
                <td id="totalHouseNay">0</td>
                <td id="totalHousePres">0</td>
              </tr>
            </tbody>
          </table>
          
          <div class="hastert-section">
            <h4 class="hastert-title">üìè Hastert Rule Analysis</h4>
            <div id="hastertRuleStatus" class="hastert-content">
              <div style="color: #666; font-style: italic; text-align: center;">No votes cast yet</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 4) The rest of your JS logic ‚Äì CRUD, rendering, autosave, localStorage, etc. -->
  <script>
    // ===== SHEETS CONFIG =====
    const SHEETS_CONFIG = {
      sessions:   { name:'Sessions',   range:'A:C' },
      partySeats: { name:'PartySeats', range:'A:D' },
      factions:   { name:'Factions',   range:'A:F' },
      senators:   { name:'Senators',   range:'A:G' },
      votes:      { name:'Votes',      range:'A:D' }
    };

    // ===== SHEET STRUCTURE & HEADER SETUP =====
    async function initializeSheetStructure() {
      try {
        const meta = await gapi.client.sheets.spreadsheets.get({ spreadsheetId:SPREADSHEET_ID });
        const existing = meta.result.sheets.map(s=>s.properties.title);
        const required = Object.values(SHEETS_CONFIG).map(c=>c.name);
        const reqs = [];
        required.forEach(name=>{
          if (!existing.includes(name)) reqs.push({ addSheet:{ properties:{ title:name } } });
        });
        if (reqs.length) {
          await gapi.client.sheets.spreadsheets.batchUpdate({
            spreadsheetId: SPREADSHEET_ID,
            resource:{ requests: reqs }
          });
          console.log(`üìã Created ${reqs.length} missing sheets`);
        }
        await initializeSheetHeaders();
      } catch(e){ console.error('Error initializing sheets:',e) }
    }

    async function initializeSheetHeaders() {
      const headers = {
        Sessions:   ['id','name','created_at'],
        PartySeats: ['session_id','party','senate_seats','house_seats'],
        Factions:   ['session_id','id','name','party','senate_count','house_count'],
        Senators:   ['session_id','id','name','party','role','faction_id','vote_weight'],
        Votes:      ['session_id','entity_id','entity_type','vote_type']
      };
      for (let [sheet, row] of Object.entries(headers)) {
        try {
          const resp = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId:SPREADSHEET_ID, range:`${sheet}!A1:Z1`
          });
          if (!resp.result.values || !resp.result.values.length) {
            await gapi.client.sheets.spreadsheets.values.update({
              spreadsheetId:SPREADSHEET_ID,
              range: `${sheet}!A1`,
              valueInputOption:'USER_ENTERED',
              resource:{ values:[row] }
            });
            console.log(`üìã Added headers to ${sheet}`);
          }
        } catch(e){
          console.warn(`Could not init headers for ${sheet}:`,e.message);
        }
      }
    }

    // ===== CRUD HELPERS =====
    async function readSheet(name) {
      try {
        const r = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId:SPREADSHEET_ID,
          range:`${name}!${SHEETS_CONFIG[name].range}`
        });
        const vals = r.result.values||[];
        if (vals.length<=1) return [];
        const hdr = vals[0];
        return vals.slice(1).map(row=>{
          const obj={};
          hdr.forEach((h,i)=> obj[h] = row[i]||'');
          return obj;
        });
      } catch(e){ console.error(`Error reading ${name}:`,e); return [] }
    }
    async function writeToSheet(name,data){
      if (!data.length) return;
      const hdr = Object.keys(data[0]);
      const vals = data.map(o=> hdr.map(h=>o[h]||''));
      await gapi.client.sheets.spreadsheets.values.clear({
        spreadsheetId:SPREADSHEET_ID,
        range:`${name}!A2:Z`
      });
      await gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId:SPREADSHEET_ID,
        range:`${name}!A2`,
        valueInputOption:'USER_ENTERED',
        resource:{ values:vals }
      });
    }
    async function appendToSheet(name,obj){
      const vals = [Object.keys(obj).map(k=>obj[k]||'')];
      await gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId:SPREADSHEET_ID,
        range:`${name}!A:A`,
        valueInputOption:'USER_ENTERED',
        insertDataOption:'INSERT_ROWS',
        resource:{ values:vals }
      });
    }

    // ===== SESSION MANAGEMENT =====
    async function loadAvailableSessions(){
      const rows = await readSheet('sessions');
      availableSessions = rows.map(r=>({ id:r.id, name:r.name, created_at:r.created_at }));
      if (!availableSessions.length) {
        const def = await createSession('Default Session');
        currentSessionId = def;
      } else {
        currentSessionId = availableSessions[0].id;
      }
      updateSessionSelector();
      console.log(`üìã Loaded ${availableSessions.length} sessions`);
    }
    async function createSession(name){
      const id = `session_${Date.now()}`;
      const rec = { session_id:id, name, created_at:new Date().toISOString() };
      await appendToSheet('sessions', { id, name, created_at:rec.created_at });
      await initializeSessionDefaults(id);
      availableSessions.push({ id, name, created_at:rec.created_at });
      currentSessionId = id;
      updateSessionSelector();
      console.log(`‚úÖ Created session ${name}`);
      return id;
    }
    async function initializeSessionDefaults(id){
      const seats = [
        { session_id:id, party:'republican', senate_seats:49, house_seats:232 },
        { session_id:id, party:'democrat',   senate_seats:50, house_seats:203 }
      ];
      for (let s of seats) await appendToSheet('partySeats', s);

      const facs = [
        { session_id:id, id:`f_${Date.now()}_1`, name:'Freedom Caucus',   party:'republican', senate_count:8,  house_count:45 },
        { session_id:id, id:`f_${Date.now()}_2`, name:'Main Street',      party:'republican', senate_count:12, house_count:65 },
        { session_id:id, id:`f_${Date.now()}_3`, name:'Traditional Rep',  party:'republican', senate_count:29, house_count:122 },
        { session_id:id, id:`f_${Date.now()}_4`, name:'Progressive Caucus',party:'democrat',   senate_count:20, house_count:98 },
        { session_id:id, id:`f_${Date.now()}_5`, name:'Blue Dog Coalition',party:'democrat',   senate_count:8,  house_count:25 },
        { session_id:id, id:`f_${Date.now()}_6`, name:'Moderate Dems',     party:'democrat',   senate_count:22, house_count:80 }
      ];
      for (let f of facs) await appendToSheet('factions', f);

      const sens = [
        { session_id:id, id:`s_${Date.now()}_1`, name:'Mitch McConnell (R-KY)', party:'republican', role:'party_leader', faction_id:facs[2].id, vote_weight:12 },
        { session_id:id, id:`s_${Date.now()}_2`, name:'John Thune (R-SD)', party:'republican', role:'party_whip', faction_id:facs[2].id, vote_weight:10 },
        { session_id:id, id:`s_${Date.now()}_3`, name:'Ted Cruz (R-TX)', party:'republican', role:'caucus_chair', faction_id:facs[0].id, vote_weight:7 },
        { session_id:id, id:`s_${Date.now()}_4`, name:'Susan Collins (R-ME)', party:'republican', role:'caucus_chair,committee_chair', faction_id:facs[1].id, vote_weight:5 },
        { session_id:id, id:`s_${Date.now()}_5`, name:'Chuck Schumer (D-NY)', party:'democrat', role:'party_leader', faction_id:facs[5].id, vote_weight:13 },
        { session_id:id, id:`s_${Date.now()}_6`, name:'Dick Durbin (D-IL)', party:'democrat', role:'party_whip', faction_id:facs[5].id, vote_weight:10 },
        { session_id:id, id:`s_${Date.now()}_7`, name:'Bernie Sanders (I-VT)', party:'democrat', role:'caucus_chair', faction_id:facs[3].id, vote_weight:8 },
        { session_id:id, id:`s_${Date.now()}_8`, name:'Joe Manchin (D-WV)', party:'democrat', role:'caucus_chair,committee_chair', faction_id:facs[4].id, vote_weight:5 }
      ];
      for (let s of sens) await appendToSheet('senators', s);
    }

    async function loadSessionFromSheets(id){
      if (!syncEnabled) return loadLocalData();
      updateSyncStatus('syncing');
      const allSeats = await readSheet('partySeats');
      const allFacs = await readSheet('factions');
      const allSens = await readSheet('senators');
      const allVotes= await readSheet('votes');

      // Filter for this session
      const sp = allSeats.filter(s=>s.session_id===id);
      partySeats = { republican:{}, democrat:{} };
      sp.forEach(s=>{
        partySeats[s.party] = {
          senate: parseInt(s.senate_seats)||0,
          house:  parseInt(s.house_seats)||0
        };
      });

      factions = { republican:[], democrat:[] };
      allFacs.filter(f=>f.session_id===id).forEach(f=>{
        factions[f.party].push({
          id:f.id,name:f.name,party:f.party,
          senate_count:parseInt(f.senate_count)||0,
          house_count: parseInt(f.house_count )||0
        });
      });

      senators = { republican:[], democrat:[] };
      allSens.filter(s=>s.session_id===id).forEach(s=>{
        const roles = s.role ? s.role.split(',').map(r => r.trim()) : ['senator'];
        senators[s.party].push({
          id:s.id,name:s.name,party:s.party,
          roles: roles,faction_id:s.faction_id
        });
      });

      votes = {};
      allVotes.filter(v=>v.session_id===id).forEach(v=>{ votes[v.entity_id]=v.vote_type; });

      clearWeightCache();
      updatePartySeatsDisplay();
      updateFactionSelectors();
      renderAll();
      updateResults();
      updateSyncStatus('synced');
      document.getElementById('connectionDetails').textContent =
        `Loaded from Google Sheets at ${new Date().toLocaleTimeString()}`;
      console.log(`üìä Session ${id} loaded`);
    }

    async function saveSessionToSheets(){
      if (!syncEnabled || !currentSessionId) return;
      updateSyncStatus('syncing');

      // Fetch all existing rows, remove this session's rows, then rewrite with updated data‚Ä¶
      const allSeats = await readSheet('partySeats');
      const filteredSeats = allSeats.filter(s=>s.session_id!==currentSessionId);
      Object.entries(partySeats).forEach(([p,sec])=>{
        filteredSeats.push({
          session_id: currentSessionId,
          party:p,
          senate_seats:sec.senate,
          house_seats:sec.house
        });
      });
      await writeToSheet('partySeats', filteredSeats);

      const allFacs = await readSheet('factions');
      const filteredFacs = allFacs.filter(f=>f.session_id!==currentSessionId);
      Object.values(factions).flat().forEach(faction => {
        filteredFacs.push({
          session_id: currentSessionId,
          id: faction.id,
          name: faction.name,
          party: faction.party,
          senate_count: faction.senate_count,
          house_count: faction.house_count
        });
      });
      await writeToSheet('factions', filteredFacs);

      const allSens = await readSheet('senators');
      const filteredSens = allSens.filter(s=>s.session_id!==currentSessionId);
      Object.values(senators).flat().forEach(senator => {
        const weights = calculateAllPartyWeights(senator.party);
        const voteWeight = weights[senator.id] || 1;
        const roles = Array.isArray(senator.roles) ? senator.roles : (senator.role ? [senator.role] : ['senator']);
        
        filteredSens.push({
          session_id: currentSessionId,
          id: senator.id,
          name: senator.name,
          party: senator.party,
          role: roles.join(','), // Convert array to comma-separated string
          faction_id: senator.faction_id || '',
          vote_weight: voteWeight
        });
      });
      await writeToSheet('senators', filteredSens);

      const allVotes = await readSheet('votes');
      const filteredVotes = allVotes.filter(v=>v.session_id!==currentSessionId);
      Object.entries(votes).forEach(([entityId, voteType]) => {
        let entityType = 'faction';
        for (const partySenators of Object.values(senators)) {
          if (partySenators.some(s => s.id === entityId)) {
            entityType = 'senator';
            break;
          }
        }
        
        filteredVotes.push({
          session_id: currentSessionId,
          entity_id: entityId,
          entity_type: entityType,
          vote_type: voteType
        });
      });
      await writeToSheet('votes', filteredVotes);

      updateSyncStatus('synced');
      document.getElementById('connectionDetails').textContent =
        `Saved to Google Sheets at ${new Date().toLocaleTimeString()}`;
      console.log('üíæ Session saved');
    }

    // ===== LOCAL STORAGE FALLBACK =====
    async function loadLocalSessions(){
      try {
        return JSON.parse(localStorage.getItem('votingSystem_sessions'))||[];
      } catch(e){ return [] }
    }
    function saveLocalSessions(){
      localStorage.setItem('votingSystem_sessions', JSON.stringify(availableSessions));
    }
    async function loadLocalData(){
      const raw = localStorage.getItem(`votingSystem_${currentSessionId}`);
      if (raw) {
        const d = JSON.parse(raw);
        factions    = d.factions    || factions;
        senators    = d.senators    || senators;
        votes       = d.votes       || votes;
        partySeats  = d.partySeats  || partySeats;
        document.getElementById('connectionDetails').textContent =
          `Local data from ${new Date(d.lastSaved).toLocaleString()}`;
      } else {
        initializeDefaultData();
        document.getElementById('connectionDetails').textContent =
          'Initialized with default data ‚Äì use üìÅ‚Üì to backup';
      }
      clearWeightCache();
      updatePartySeatsDisplay();
      updateFactionSelectors();
      renderAll();
      updateResults();
    }
    function saveToLocalStorage(){
      localStorage.setItem(
        `votingSystem_${currentSessionId}`,
        JSON.stringify({ factions, senators, votes, partySeats, lastSaved:new Date().toISOString() })
      );
      saveLocalSessions();
      document.getElementById('connectionDetails').textContent =
        `Saved locally at ${new Date().toLocaleTimeString()} ‚Äì use üìÅ‚Üì to backup`;
      console.log('üíæ Data saved locally');
    }
    function initializeDefaultData(){
      factions = {
        republican: [
          { id: Date.now() + 1, name: 'Freedom Caucus', party: 'republican', senate_count: 8, house_count: 45 },
          { id: Date.now() + 2, name: 'Main Street Partnership', party: 'republican', senate_count: 12, house_count: 65 },
          { id: Date.now() + 3, name: 'Traditional Republicans', party: 'republican', senate_count: 29, house_count: 122 }
        ],
        democrat: [
          { id: Date.now() + 4, name: 'Progressive Caucus', party: 'democrat', senate_count: 20, house_count: 98 },
          { id: Date.now() + 5, name: 'Blue Dog Coalition', party: 'democrat', senate_count: 8, house_count: 25 },
          { id: Date.now() + 6, name: 'Moderate Democrats', party: 'democrat', senate_count: 22, house_count: 80 }
        ]
      };
      
      senators = {
        republican: [
          { id: Date.now() + 11, name: 'Mitch McConnell (R-KY)', party: 'republican', roles: ['party_leader'], faction_id: Date.now() + 3 },
          { id: Date.now() + 12, name: 'John Thune (R-SD)', party: 'republican', roles: ['party_whip'], faction_id: Date.now() + 3 },
          { id: Date.now() + 13, name: 'Ted Cruz (R-TX)', party: 'republican', roles: ['caucus_chair'], faction_id: Date.now() + 1 },
          { id: Date.now() + 14, name: 'Susan Collins (R-ME)', party: 'republican', roles: ['caucus_chair', 'committee_chair'], faction_id: Date.now() + 2 }
        ],
        democrat: [
          { id: Date.now() + 21, name: 'Chuck Schumer (D-NY)', party: 'democrat', roles: ['party_leader'], faction_id: Date.now() + 6 },
          { id: Date.now() + 22, name: 'Dick Durbin (D-IL)', party: 'democrat', roles: ['party_whip'], faction_id: Date.now() + 6 },
          { id: Date.now() + 23, name: 'Bernie Sanders (I-VT)', party: 'democrat', roles: ['caucus_chair'], faction_id: Date.now() + 4 },
          { id: Date.now() + 24, name: 'Joe Manchin (D-WV)', party: 'democrat', roles: ['caucus_chair', 'committee_chair'], faction_id: Date.now() + 5 }
        ]
      };
      
      votes = {};
      partySeats = {
        republican: { senate: 49, house: 232 },
        democrat: { senate: 50, house: 203 }
      };
      
      clearWeightCache();
    }

    function exportAllData() {
      const exportData = {
        sessions: availableSessions,
        sessionData: {}
      };
      
      availableSessions.forEach(session => {
        const stored = localStorage.getItem(`votingSystem_${session.id}`);
        if (stored) {
          exportData.sessionData[session.id] = JSON.parse(stored);
        }
      });
      
      const dataStr = JSON.stringify(exportData, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `voting_system_backup_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      console.log('üìÅ Exported all data to file');
    }

    function importAllData() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        try {
          const text = await file.text();
          const importData = JSON.parse(text);
          
          if (importData.sessions && importData.sessionData) {
            availableSessions = importData.sessions;
            saveLocalSessions();
            
            Object.entries(importData.sessionData).forEach(([sessionId, data]) => {
              localStorage.setItem(`votingSystem_${sessionId}`, JSON.stringify(data));
            });
            
            if (availableSessions.length > 0) {
              currentSessionId = availableSessions[0].id;
              await loadLocalData();
              updateSessionSelector();
            }
            
            const detailsEl = document.getElementById('connectionDetails');
            if (detailsEl) {
              detailsEl.textContent = `Imported ${availableSessions.length} sessions from file`;
            }
            
            console.log('üìÅ Imported all data from file');
            alert('Data imported successfully!');
          } else {
            throw new Error('Invalid file format');
          }
        } catch (error) {
          console.error('Import error:', error);
          alert('Error importing file: ' + error.message);
        }
      };
      
      input.click();
    }

    // ===== VOTE WEIGHT CALCULATIONS =====
    function calculateSenatorVoteWeight(senator, party) {
      if (window.cachedWeights && window.cachedWeights[party] && window.cachedWeights[party][senator.id] !== undefined) {
        return window.cachedWeights[party][senator.id];
      }
      return calculateAllPartyWeights(party)[senator.id] || 0;
    }

    function calculateAllPartyWeights(party) {
      const totalPartySeats = partySeats[party].senate;
      if (totalPartySeats === 0) return {};
      
      const partySenators = senators[party];
      if (partySenators.length === 0) return {};
      
      const finalWeights = {};
      
      // Step 1: Calculate Party Leader/Whip bonuses first (based on total party seats)
      const leadershipWeights = {};
      let totalLeadershipSeats = 0;
      
      partySenators.forEach(senator => {
        const roles = Array.isArray(senator.roles) ? senator.roles : (senator.role ? [senator.role] : ['senator']);
        let leadershipBonus = 0;
        
        roles.forEach(role => {
          if (role === 'party_leader') {
            leadershipBonus += Math.round(totalPartySeats * 0.25);
          } else if (role === 'party_whip') {
            leadershipBonus += Math.round(totalPartySeats * 0.20);
          }
        });
        
        if (leadershipBonus > 0) {
          leadershipWeights[senator.id] = leadershipBonus;
          totalLeadershipSeats += leadershipBonus;
        }
      });
      
      // Step 2: Calculate remaining seats for faction distribution
      const remainingSeats = Math.max(0, totalPartySeats - totalLeadershipSeats);
      
      // Step 3: Group senators by faction and calculate faction allocations
      const factionGroups = {};
      let totalFactionSeats = 0;
      
      partySenators.forEach(senator => {
        if (senator.faction_id) {
          if (!factionGroups[senator.faction_id]) {
            factionGroups[senator.faction_id] = [];
          }
          factionGroups[senator.faction_id].push(senator);
        }
      });
      
      // Calculate total faction seats for proportional distribution
      Object.keys(factionGroups).forEach(factionId => {
        const faction = factions[party].find(f => f.id === factionId);
        if (faction) {
          totalFactionSeats += faction.senate_count || 0;
        }
      });
      
      // Step 4: Distribute remaining seats among factions proportionally
      Object.entries(factionGroups).forEach(([factionId, senatorsInFaction]) => {
        const faction = factions[party].find(f => f.id === factionId);
        if (!faction || senatorsInFaction.length === 0) return;
        
        const factionSeats = faction.senate_count || 0;
        const factionAllocation = totalFactionSeats > 0 ? 
          Math.round((factionSeats / totalFactionSeats) * remainingSeats) : 0;
        
        // Distribute faction allocation based on role weights
        const roleWeights = { 'caucus_chair': 3, 'senator': 1 };
        let totalRoleWeight = 0;
        
        senatorsInFaction.forEach(senator => {
          const roles = Array.isArray(senator.roles) ? senator.roles : (senator.role ? [senator.role] : ['senator']);
          const factionRoles = roles.filter(r => r !== 'party_leader' && r !== 'party_whip');
          const maxWeight = Math.max(...factionRoles.map(r => roleWeights[r] || 1));
          totalRoleWeight += maxWeight;
        });
        
        senatorsInFaction.forEach(senator => {
          const roles = Array.isArray(senator.roles) ? senator.roles : (senator.role ? [senator.role] : ['senator']);
          const factionRoles = roles.filter(r => r !== 'party_leader' && r !== 'party_whip');
          const maxWeight = Math.max(...factionRoles.map(r => roleWeights[r] || 1));
          
          const factionWeight = totalRoleWeight > 0 ? 
            Math.round((factionAllocation * maxWeight) / totalRoleWeight) : 0;
          
          finalWeights[senator.id] = factionWeight + (leadershipWeights[senator.id] || 0);
        });
      });
      
      // Handle unassigned senators
      const unassignedSenators = partySenators.filter(s => !s.faction_id);
      unassignedSenators.forEach(senator => {
        finalWeights[senator.id] = (leadershipWeights[senator.id] || 0) + 1;
      });
      
      // Ensure minimum weight of 1
      partySenators.forEach(senator => {
        finalWeights[senator.id] = Math.max(1, finalWeights[senator.id] || 1);
      });
      
      if (!window.cachedWeights) window.cachedWeights = {};
      window.cachedWeights[party] = finalWeights;
      
      return finalWeights;
    }

    function getSenatorDisplayWeight(senator, party) {
      return calculateSenatorVoteWeight(senator, party);
    }

    function getRoleDisplayName(roles) {
      if (!roles) return 'Senator';
      
      const roleArray = Array.isArray(roles) ? roles : [roles];
      const displayNames = roleArray.map(role => {
        switch(role) {
          case 'party_leader': return 'Party Leader';
          case 'party_whip': return 'Party Whip';
          case 'caucus_chair': return 'Caucus Chair';
          case 'committee_chair': return 'Committee Chair';
          case 'senator':
          default: return 'Senator';
        }
      });
      
      return displayNames.filter(name => name !== 'Senator').join(', ') || 'Senator';
    }

    // ===== RENDERING & VOTING LOGIC =====
    function renderAll() {
      renderSenators();
      renderHouseFactions();
      updateSeatCounts();
      updateResults(); // This will also update the Hastert Rule display
    }

    function renderSenators() {
      ['republican', 'democrat'].forEach(party => {
        const container = document.getElementById(party === 'republican' ? 'republicanSenators' : 'democratSenators');
        
        // Group senators by faction
        const factionGroups = {};
        const unassignedSenators = [];
        
        senators[party].forEach(senator => {
          if (senator.faction_id) {
            const faction = factions[party].find(f => f.id === senator.faction_id);
            if (faction) {
              if (!factionGroups[faction.id]) {
                factionGroups[faction.id] = {
                  faction: faction,
                  senators: []
                };
              }
              factionGroups[faction.id].senators.push(senator);
            } else {
              unassignedSenators.push(senator);
            }
          } else {
            unassignedSenators.push(senator);
          }
        });
        
        let html = '';
        
        // Render each faction group
        Object.values(factionGroups).forEach(group => {
          const sortedSenators = [...group.senators].sort((a, b) => {
            const aRoles = Array.isArray(a.roles) ? a.roles : (a.role ? [a.role] : ['senator']);
            const bRoles = Array.isArray(b.roles) ? b.roles : (b.role ? [b.role] : ['senator']);
            const roleOrder = { 'party_leader': 0, 'party_whip': 1, 'caucus_chair': 2, 'committee_chair': 3, 'senator': 4 };
            const aMinRole = Math.min(...aRoles.map(r => roleOrder[r] || 4));
            const bMinRole = Math.min(...bRoles.map(r => roleOrder[r] || 4));
            return aMinRole - bMinRole;
          });
          
          // Only show senate seats for Senate faction display
          const senateSeats = group.faction.senate_count;
          
          html += `
            <div class="faction-group">
              <div class="faction-group-header">
                <span>${group.faction.name}</span>
                <span class="faction-count-badge">${sortedSenators.length} senator${sortedSenators.length !== 1 ? 's' : ''} | ${senateSeats} senate seats</span>
              </div>
              ${sortedSenators.map(senator => {
                const roles = Array.isArray(senator.roles) ? senator.roles : (senator.role ? [senator.role] : ['senator']);
                const roleDisplay = getRoleDisplayName(roles);
                const voteWeight = getSenatorDisplayWeight(senator, party);
                
                return `
                  <div class="faction-item">
                    <div class="faction-info">
                      <div class="faction-name">${senator.name}</div>
                      <div class="faction-count">
                        ${roleDisplay} | Weight: ${voteWeight} votes
                      </div>
                    </div>
                    <div class="vote-buttons">
                      <button class="vote-btn aye ${votes[senator.id] === 'aye' ? 'active' : ''}" 
                              onclick="vote('${senator.id}', 'aye', true)">AYE</button>
                      <button class="vote-btn nay ${votes[senator.id] === 'nay' ? 'active' : ''}" 
                              onclick="vote('${senator.id}', 'nay', true)">NAY</button>
                      <button class="vote-btn pres ${votes[senator.id] === 'pres' ? 'active' : ''}" 
                              onclick="vote('${senator.id}', 'pres', true)">PRES</button>
                    </div>
                    <button class="delete-btn" onclick="editSenator('${party}', '${senator.id}')" style="background: #007bff; margin-right: 5px;">‚úè</button>
                    <button class="delete-btn" onclick="removeSenator('${party}', '${senator.id}')">√ó</button>
                  </div>
                `;
              }).join('')}
            </div>
          `;
        });
        
        // Render unassigned senators
        if (unassignedSenators.length > 0) {
          const sortedUnassigned = [...unassignedSenators].sort((a, b) => {
            const aRoles = Array.isArray(a.roles) ? a.roles : (a.role ? [a.role] : ['senator']);
            const bRoles = Array.isArray(b.roles) ? b.roles : (b.role ? [b.role] : ['senator']);
            const roleOrder = { 'party_leader': 0, 'party_whip': 1, 'caucus_chair': 2, 'committee_chair': 3, 'senator': 4 };
            const aMinRole = Math.min(...aRoles.map(r => roleOrder[r] || 4));
            const bMinRole = Math.min(...bRoles.map(r => roleOrder[r] || 4));
            return aMinRole - bMinRole;
          });
          
          html += `
            <div class="unassigned-group">
              <div class="unassigned-group-header">
                <span>Unassigned Senators</span>
                <span class="faction-count-badge">${sortedUnassigned.length} senator${sortedUnassigned.length !== 1 ? 's' : ''}</span>
              </div>
              ${sortedUnassigned.map(senator => {
                const roles = Array.isArray(senator.roles) ? senator.roles : (senator.role ? [senator.role] : ['senator']);
                const roleDisplay = getRoleDisplayName(roles);
                const voteWeight = getSenatorDisplayWeight(senator, party);
                
                return `
                  <div class="faction-item">
                    <div class="faction-info">
                      <div class="faction-name">${senator.name}</div>
                      <div class="faction-count">
                        ${roleDisplay} | No Faction | Weight: ${voteWeight} votes
                      </div>
                    </div>
                    <div class="vote-buttons">
                      <button class="vote-btn aye ${votes[senator.id] === 'aye' ? 'active' : ''}" 
                              onclick="vote('${senator.id}', 'aye', true)">AYE</button>
                      <button class="vote-btn nay ${votes[senator.id] === 'nay' ? 'active' : ''}" 
                              onclick="vote('${senator.id}', 'nay', true)">NAY</button>
                      <button class="vote-btn pres ${votes[senator.id] === 'pres' ? 'active' : ''}" 
                              onclick="vote('${senator.id}', 'pres', true)">PRES</button>
                    </div>
                    <button class="delete-btn" onclick="editSenator('${party}', '${senator.id}')" style="background: #007bff; margin-right: 5px;">‚úè</button>
                    <button class="delete-btn" onclick="removeSenator('${party}', '${senator.id}')">√ó</button>
                  </div>
                `;
              }).join('')}
            </div>
          `;
        }
        
        container.innerHTML = html;
      });
    }

    function renderHouseFactions() {
      ['republican', 'democrat'].forEach(party => {
        const container = document.getElementById(party === 'republican' ? 'republicanHouseFactions' : 'democratHouseFactions');
        
        container.innerHTML = factions[party].filter(f => f.house_count > 0).map(faction => {
          const totalSeats = faction.senate_count + faction.house_count;
          return `
            <div class="faction-item">
              <div class="faction-info">
                <div class="faction-name">${faction.name}</div>
                <div class="faction-count">${faction.house_count} House members | ${totalSeats} total seats</div>
              </div>
              <div class="vote-buttons">
                <button class="vote-btn aye ${votes[faction.id] === 'aye' ? 'active' : ''}" 
                        onclick="vote('${faction.id}', 'aye', false)">AYE</button>
                <button class="vote-btn nay ${votes[faction.id] === 'nay' ? 'active' : ''}" 
                        onclick="vote('${faction.id}', 'nay', false)">NAY</button>
                <button class="vote-btn pres ${votes[faction.id] === 'pres' ? 'active' : ''}" 
                        onclick="vote('${faction.id}', 'pres', false)">PRES</button>
              </div>
              <button class="delete-btn" onclick="editFaction('${party}', '${faction.id}')" style="background: #007bff; margin-right: 5px;">‚úè</button>
              <button class="delete-btn" onclick="removeFaction('${party}', '${faction.id}')">√ó</button>
            </div>
          `;
        }).join('');
      });
    }

    function updateSeatCounts() {
      const repHouseCurrent = factions.republican.reduce((sum, f) => sum + (f.house_count || 0), 0);
      const demHouseCurrent = factions.democrat.reduce((sum, f) => sum + (f.house_count || 0), 0);

      const repWeights = calculateAllPartyWeights('republican');
      const demWeights = calculateAllPartyWeights('democrat');
      const repTotalWeight = Object.values(repWeights).reduce((sum, weight) => sum + weight, 0);
      const demTotalWeight = Object.values(demWeights).reduce((sum, weight) => sum + weight, 0);

      // Show total weighted votes as numerator, not senator count
      document.getElementById('repSenateCurrent').textContent = repTotalWeight;
      document.getElementById('demSenateCurrent').textContent = demTotalWeight;
      document.getElementById('repHouseCurrent').textContent = repHouseCurrent;
      document.getElementById('demHouseCurrent').textContent = demHouseCurrent;
      
      document.getElementById('repSenateTotal').textContent = partySeats.republican.senate;
      document.getElementById('repHouseTotal').textContent = partySeats.republican.house;
      document.getElementById('demSenateTotal').textContent = partySeats.democrat.senate;
      document.getElementById('demHouseTotal').textContent = partySeats.democrat.house;
      
      document.getElementById('repSenateWeight').textContent = repTotalWeight;
      document.getElementById('demSenateWeight').textContent = demTotalWeight;
    }

    function vote(id, voteType, isSenator = false) {
      votes[id] = voteType;
      renderAll();
      updateResults();
      autoSave();
      
      console.log(`üó≥Ô∏è Vote recorded: ${isSenator ? 'Senator' : 'Faction'} ${id} voted ${voteType}`);
    }

    function calculateResults() {
      const results = {
        republican: { senate: { aye: 0, nay: 0, pres: 0 }, house: { aye: 0, nay: 0, pres: 0 } },
        democrat: { senate: { aye: 0, nay: 0, pres: 0 }, house: { aye: 0, nay: 0, pres: 0 } }
      };

      ['republican', 'democrat'].forEach(party => {
        senators[party].forEach(senator => {
          const vote = votes[senator.id];
          if (vote) {
            const weight = calculateSenatorVoteWeight(senator, party);
            results[party].senate[vote] += weight;
          }
        });
      });

      ['republican', 'democrat'].forEach(party => {
        factions[party].forEach(faction => {
          const vote = votes[faction.id];
          if (vote && faction.house_count > 0) {
            results[party].house[vote] += faction.house_count;
          }
        });
      });

      ['republican', 'democrat'].forEach(party => {
        ['aye', 'nay', 'pres'].forEach(voteType => {
          results[party].senate[voteType] = Math.round(results[party].senate[voteType]);
        });
      });

      return results;
    }

    function updateResults() {
      const results = calculateResults();
      
      document.getElementById('repSenateAye').textContent = results.republican.senate.aye;
      document.getElementById('repSenateNay').textContent = results.republican.senate.nay;
      document.getElementById('repSenatePres').textContent = results.republican.senate.pres;
      
      document.getElementById('demSenateAye').textContent = results.democrat.senate.aye;
      document.getElementById('demSenateNay').textContent = results.democrat.senate.nay;
      document.getElementById('demSenatePres').textContent = results.democrat.senate.pres;
      
      document.getElementById('totalSenateAye').textContent = 
        results.republican.senate.aye + results.democrat.senate.aye;
      document.getElementById('totalSenateNay').textContent = 
        results.republican.senate.nay + results.democrat.senate.nay;
      document.getElementById('totalSenatePres').textContent = 
        results.republican.senate.pres + results.democrat.senate.pres;

      document.getElementById('repHouseAye').textContent = results.republican.house.aye;
      document.getElementById('repHouseNay').textContent = results.republican.house.nay;
      document.getElementById('repHousePres').textContent = results.republican.house.pres;
      
      document.getElementById('demHouseAye').textContent = results.democrat.house.aye;
      document.getElementById('demHouseNay').textContent = results.democrat.house.nay;
      document.getElementById('demHousePres').textContent = results.democrat.house.pres;
      
      document.getElementById('totalHouseAye').textContent = 
        results.republican.house.aye + results.democrat.house.aye;
      document.getElementById('totalHouseNay').textContent = 
        results.republican.house.nay + results.democrat.house.nay;
      document.getElementById('totalHousePres').textContent = 
        results.republican.house.pres + results.democrat.house.pres;

      // Update Hastert Rule status
      updateHastertRuleStatus(results);
    }

    function updateHastertRuleStatus(results) {
      const hastertEl = document.getElementById('hastertRuleStatus');
      if (!hastertEl) return;

      const repSeats = partySeats.republican.house;
      const demSeats = partySeats.democrat.house;
      const totalSeats = repSeats + demSeats;
      
      // Determine majority party
      const majorityParty = repSeats > demSeats ? 'republican' : 'democrat';
      const minorityParty = majorityParty === 'republican' ? 'democrat' : 'republican';
      const majoritySeats = Math.max(repSeats, demSeats);
      const majorityThreshold = Math.ceil(majoritySeats / 2);
      
      const majorityAyes = results[majorityParty].house.aye;
      const minorityAyes = results[minorityParty].house.aye;
      const totalAyes = majorityAyes + minorityAyes;
      
      // Check if any votes have been cast
      const totalVotesCast = totalAyes + results.republican.house.nay + results.democrat.house.nay + 
                            results.republican.house.pres + results.democrat.house.pres;
      
      if (totalVotesCast === 0) {
        hastertEl.innerHTML = '<div style="color: #666; font-style: italic; text-align: center;">No votes cast yet</div>';
        return;
      }

      const majorityPartyName = majorityParty === 'republican' ? 'Republican' : 'Democrat';
      const hastertMet = majorityAyes >= majorityThreshold;
      const billPassing = totalAyes > Math.floor(totalSeats / 2);
      
      let statusHtml = `
        <div style="margin-bottom: 12px; text-align: center;">
          <div style="margin-bottom: 6px;"><strong>Majority Party:</strong> ${majorityPartyName} (${majoritySeats} seats)</div>
          <div style="margin-bottom: 6px;"><strong>Hastert Threshold:</strong> ${majorityThreshold} ${majorityPartyName} votes needed</div>
          <div><strong>Current ${majorityPartyName} Ayes:</strong> ${majorityAyes}</div>
        </div>
      `;

      if (hastertMet) {
        statusHtml += `
          <div class="hastert-satisfied">
            ‚úÖ HASTERT RULE: SATISFIED
          </div>
        `;
      } else {
        const needed = majorityThreshold - majorityAyes;
        statusHtml += `
          <div class="hastert-not-met">
            ‚ùå HASTERT RULE: NOT MET<br>
            <small>Need ${needed} more ${majorityPartyName} votes</small>
          </div>
        `;
      }

      if (billPassing) {
        statusHtml += `
          <div class="bill-status-passing">
            üìä Bill Status: PASSING (${totalAyes} total ayes)
          </div>
        `;
      } else {
        statusHtml += `
          <div class="bill-status-failing">
            üìä Bill Status: FAILING (${totalAyes} total ayes)
          </div>
        `;
      }

      hastertEl.innerHTML = statusHtml;
    }

    // ===== SESSION UI HELPERS =====
    async function switchSession() {
      const newSessionId = document.getElementById('sessionSelect').value;
      
      if (newSessionId === currentSessionId) return;
      
      if (syncEnabled) {
        await saveSessionToSheets();
      } else {
        saveToLocalStorage();
      }
      
      currentSessionId = newSessionId;
      
      if (syncEnabled) {
        await loadSessionFromSheets(currentSessionId);
      } else {
        await loadLocalData();
      }
      
      console.log(`üîÑ Switched to session: ${currentSessionId}`);
    }

    async function createNewSession() {
      const name = prompt('Enter new session name:');
      if (!name || name.trim() === '') return;
      
      const sessionName = name.trim();
      
      try {
        if (syncEnabled) {
          await createSession(sessionName);
          await loadSessionFromSheets(currentSessionId);
        } else {
          await createLocalSession(sessionName);
        }
        
        updateSessionSelector();
        document.getElementById('sessionSelect').value = currentSessionId;
        renderAll();
        updateResults();
        
      } catch (error) {
        alert('Error creating session: ' + error.message);
      }
    }

    async function createLocalSession(sessionName) {
      const sessionId = `local_${Date.now()}`;
      const newSession = {
        id: sessionId,
        name: sessionName,
        created_at: new Date().toISOString()
      };
      
      availableSessions.push(newSession);
      saveLocalSessions();
      
      currentSessionId = sessionId;
      initializeDefaultData();
      saveToLocalStorage();
      
      return sessionId;
    }

    function updateSessionSelector() {
      const select = document.getElementById('sessionSelect');
      select.innerHTML = '';
      
      availableSessions.forEach(session => {
        const option = document.createElement('option');
        option.value = session.id;
        option.textContent = session.name;
        select.appendChild(option);
      });
      
      select.value = currentSessionId;
    }

    // ===== PARTY SEATS UI =====
    function updatePartySeats() {
      partySeats = {
        republican: {
          senate: parseInt(document.getElementById('repSenateSeats').value) || 0,
          house: parseInt(document.getElementById('repHouseSeats').value) || 0
        },
        democrat: {
          senate: parseInt(document.getElementById('demSenateSeats').value) || 0,
          house: parseInt(document.getElementById('demHouseSeats').value) || 0
        }
      };
      
      clearWeightCache();
      updatePartySeatsDisplay();
      updateSeatCounts();
      autoSave();
      updateResults();
    }

    function updatePartySeatsDisplay() {
      document.getElementById('repSenateSeats').value = partySeats.republican.senate;
      document.getElementById('repHouseSeats').value = partySeats.republican.house;
      document.getElementById('demSenateSeats').value = partySeats.democrat.senate;
      document.getElementById('demHouseSeats').value = partySeats.democrat.house;
      
      document.getElementById('repSenateTotal').textContent = partySeats.republican.senate;
      document.getElementById('repHouseTotal').textContent = partySeats.republican.house;
      document.getElementById('demSenateTotal').textContent = partySeats.democrat.senate;
      document.getElementById('demHouseTotal').textContent = partySeats.democrat.house;
    }

    // ===== FACTION UI =====
    function addFaction() {
      const name = document.getElementById('factionName').value.trim();
      const party = document.getElementById('factionParty').value;
      const senateCount = parseInt(document.getElementById('factionSenateCount').value) || 0;
      const houseCount = parseInt(document.getElementById('factionHouseCount').value) || 0;

      if (!name) {
        alert('Please enter a faction name');
        return;
      }

      const newFaction = {
        id: crypto.randomUUID ? crypto.randomUUID() : `temp_${Date.now()}`,
        name: name,
        party: party,
        senate_count: senateCount,
        house_count: houseCount
      };
      
      factions[party].push(newFaction);
      
      document.getElementById('factionName').value = '';
      document.getElementById('factionSenateCount').value = '0';
      document.getElementById('factionHouseCount').value = '0';
      
      clearWeightCache();
      updateFactionSelectors();
      renderAll();
      updateResults();
      autoSave();
    }

    function showAddFaction(party) {
      document.getElementById('factionParty').value = party;
      document.getElementById('factionName').focus();
    }

    function removeFaction(party, id) {
      factions[party] = factions[party].filter(f => f.id !== id);
      delete votes[id];
      clearWeightCache();
      updateFactionSelectors();
      renderAll();
      updateResults();
      autoSave();
    }

    function updateFactionSelectors() {
      const senatorFactionSelect = document.getElementById('senatorFaction');
      const bulkFactionSelect = document.getElementById('bulkFaction');
      
      senatorFactionSelect.innerHTML = '<option value="">Select faction...</option>';
      bulkFactionSelect.innerHTML = '<option value="">No faction</option>';
      
      ['republican', 'democrat'].forEach(party => {
        factions[party].forEach(faction => {
          const option1 = document.createElement('option');
          option1.value = faction.id;
          option1.textContent = `${faction.name} (${party.charAt(0).toUpperCase() + party.slice(1)})`;
          senatorFactionSelect.appendChild(option1);
          
          const option2 = document.createElement('option');
          option2.value = faction.id;
          option2.textContent = `${faction.name} (${party.charAt(0).toUpperCase() + party.slice(1)})`;
          bulkFactionSelect.appendChild(option2);
        });
      });
    }

    // ===== SENATOR UI =====
    function addSenator() {
      const name = document.getElementById('senatorName').value.trim();
      const party = document.getElementById('senatorParty').value;
      const roleSelect = document.getElementById('senatorRole');
      const selectedRoles = Array.from(roleSelect.selectedOptions).map(option => option.value);
      const factionId = document.getElementById('senatorFaction').value;

      if (!name) {
        alert('Please enter a senator name');
        return;
      }

      // Check for exclusive leadership roles per party
      const exclusiveRoles = ['party_leader', 'party_whip'];
      for (const role of exclusiveRoles) {
        if (selectedRoles.includes(role)) {
          const existingRoles = senators[party].filter(s => {
            const roles = Array.isArray(s.roles) ? s.roles : (s.role ? [s.role] : []);
            return roles.includes(role);
          });
          if (existingRoles.length > 0) {
            const roleName = role.replace('_', ' ');
            alert(`There can only be one ${roleName} per party. Current ${roleName}: ${existingRoles[0].name}`);
            return;
          }
        }
      }

      const newSenator = {
        id: Date.now(),
        name: name,
        party: party,
        roles: selectedRoles.length > 0 ? selectedRoles : ['senator'],
        faction_id: factionId ? factionId : null
      };
      
      senators[party].push(newSenator);
      document.getElementById('senatorName').value = '';
      
      // Reset role selection
      for (let option of roleSelect.options) {
        option.selected = false;
      }
      
      clearWeightCache();
      renderAll();
      updateResults();
      autoSave();
    }

    function editSenator(party, id) {
      const senator = senators[party].find(s => s.id == id);
      if (!senator) return;

      // Create edit form
      const editForm = `
        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; min-width: 400px;">
          <h3 style="margin-bottom: 15px;">Edit Senator</h3>
          
          <label>Name:</label>
          <input type="text" id="editName" value="${senator.name}" style="width: 100%; margin-bottom: 10px;">
          
          <label>Party:</label>
          <select id="editParty" style="width: 100%; margin-bottom: 10px;">
            <option value="republican" ${senator.party === 'republican' ? 'selected' : ''}>Republican</option>
            <option value="democrat" ${senator.party === 'democrat' ? 'selected' : ''}>Democrat</option>
          </select>
          
          <label>Roles:</label>
          <select id="editRoles" multiple style="width: 100%; height: 80px; margin-bottom: 10px;">
            <option value="senator">Senator</option>
            <option value="party_leader">Party Leader</option>
            <option value="party_whip">Party Whip</option>
            <option value="caucus_chair">Caucus Chair</option>
          </select>
          
          <label>Faction:</label>
          <select id="editFaction" style="width: 100%; margin-bottom: 15px;">
            <option value="">No faction</option>
          </select>
          
          <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="cancelEdit()" style="background: #6c757d;">Cancel</button>
            <button onclick="saveEdit('${party}', '${id}')" style="background: #28a745;">Save</button>
          </div>
        </div>
        <div id="editOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999;" onclick="cancelEdit()"></div>
      `;

      document.body.insertAdjacentHTML('beforeend', editForm);

      // Populate faction dropdown
      const editFactionSelect = document.getElementById('editFaction');
      ['republican', 'democrat'].forEach(p => {
        factions[p].forEach(faction => {
          const option = document.createElement('option');
          option.value = faction.id;
          option.textContent = `${faction.name} (${p.charAt(0).toUpperCase() + p.slice(1)})`;
          option.selected = faction.id === senator.faction_id;
          editFactionSelect.appendChild(option);
        });
      });

      // Set selected roles
      const editRoles = document.getElementById('editRoles');
      const senatorRoles = Array.isArray(senator.roles) ? senator.roles : (senator.role ? [senator.role] : ['senator']);
      Array.from(editRoles.options).forEach(option => {
        option.selected = senatorRoles.includes(option.value);
      });
    }

    function saveEdit(party, id) {
      const senator = senators[party].find(s => s.id == id);
      if (!senator) return;

      const newName = document.getElementById('editName').value.trim();
      const newParty = document.getElementById('editParty').value;
      const editRoles = document.getElementById('editRoles');
      const selectedRoles = Array.from(editRoles.selectedOptions).map(option => option.value);
      const newFaction = document.getElementById('editFaction').value;

      if (!newName) {
        alert('Please enter a senator name');
        return;
      }

      // Check for exclusive leadership roles if changing party or roles
      if (newParty !== party || !arraysEqual(selectedRoles, senator.roles)) {
        const exclusiveRoles = ['party_leader', 'party_whip'];
        for (const role of exclusiveRoles) {
          if (selectedRoles.includes(role)) {
            const existingRoles = senators[newParty].filter(s => {
              if (s.id === senator.id) return false; // Exclude current senator
              const roles = Array.isArray(s.roles) ? s.roles : (s.role ? [s.role] : []);
              return roles.includes(role);
            });
            if (existingRoles.length > 0) {
              const roleName = role.replace('_', ' ');
              alert(`There can only be one ${roleName} per party. Current ${roleName}: ${existingRoles[0].name}`);
              return;
            }
          }
        }
      }

      // Remove from old party if changed
      if (newParty !== party) {
        senators[party] = senators[party].filter(s => s.id !== senator.id);
      }

      // Update senator
      senator.name = newName;
      senator.party = newParty;
      senator.roles = selectedRoles.length > 0 ? selectedRoles : ['senator'];
      senator.faction_id = newFaction || null;

      // Add to new party if changed
      if (newParty !== party) {
        senators[newParty].push(senator);
      }

      cancelEdit();
      clearWeightCache();
      renderAll();
      updateResults();
      autoSave();
    }

    function cancelEdit() {
      const editForm = document.querySelector('div[style*="position: fixed"]');
      const overlay = document.getElementById('editOverlay');
      if (editForm) editForm.remove();
      if (overlay) overlay.remove();
    }

    function arraysEqual(a, b) {
      if (!Array.isArray(a) || !Array.isArray(b)) return false;
      if (a.length !== b.length) return false;
      return a.every((val, index) => val === b[index]);
    }

    function addBulkSenators() {
      const bulkText = document.getElementById('bulkSenators').value.trim();
      const defaultParty = document.getElementById('bulkParty').value;
      const defaultFaction = document.getElementById('bulkFaction').value;

      if (!bulkText) {
        alert('Please enter senator names');
        return;
      }

      const lines = bulkText.split('\n').filter(line => line.trim());
      let addedCount = 0;

      lines.forEach(line => {
        const trimmed = line.trim();
        if (!trimmed) return;

        const newSenator = {
          id: Date.now() + addedCount,
          name: trimmed,
          party: defaultParty,
          roles: ['senator'],
          faction_id: defaultFaction || null
        };

        senators[defaultParty].push(newSenator);
        addedCount++;
      });

      document.getElementById('bulkSenators').value = '';
      
      clearWeightCache();
      renderAll();
      updateResults();
      autoSave();
      
      alert(`Added ${addedCount} senators`);
    }

    function editFaction(party, id) {
      const faction = factions[party].find(f => f.id === id);
      if (!faction) return;

      const newName = prompt('Edit faction name:', faction.name);
      if (newName && newName.trim() !== '') {
        faction.name = newName.trim();
      }

      const newSenateCount = prompt('Edit senate seats:', faction.senate_count);
      if (newSenateCount !== null && !isNaN(newSenateCount)) {
        faction.senate_count = parseInt(newSenateCount) || 0;
      }

      const newHouseCount = prompt('Edit house seats:', faction.house_count);
      if (newHouseCount !== null && !isNaN(newHouseCount)) {
        faction.house_count = parseInt(newHouseCount) || 0;
      }

      clearWeightCache();
      updateFactionSelectors();
      renderAll();
      updateResults();
      autoSave();
    }

    function removeSenator(party, id) {
      senators[party] = senators[party].filter(s => s.id !== id);
      delete votes[id];
      clearWeightCache();
      renderAll();
      updateResults();
      autoSave();
    }

    // ===== UTILITY =====
    function clearWeightCache() { 
      window.cachedWeights = {}; 
    }

    function clearAllVotes() {
      if (!confirm('Are you sure you want to clear all votes?')) return;
      
      votes = {};
      renderAll();
      updateResults();
      autoSave();
    }

    function resetToDefaults() {
      if (!confirm('Reset to default data? This will clear all your current data.')) return;
      
      initializeDefaultData();
      clearWeightCache();
      updatePartySeatsDisplay();
      updateFactionSelectors();
      renderAll();
      updateResults();
      autoSave();
      console.log('üîÑ Reset to default data');
    }

    function exportResults() {
      const results = calculateResults();
      const exportData = {
        session_id: currentSessionId,
        timestamp: new Date().toISOString(),
        party_seats: partySeats,
        factions: factions,
        senators: senators,
        votes: votes,
        results: results
      };
      
      const dataStr = JSON.stringify(exportData, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      const sessionName = availableSessions.find(s => s.id === currentSessionId)?.name || currentSessionId;
      a.download = `voting_results_${sessionName}_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function updateSyncStatus(status) {
      const statusEl = document.getElementById('syncStatus');
      const syncBtn = document.getElementById('syncBtn');
      const detailsEl = document.getElementById('connectionDetails');
      
      if (statusEl) {
        statusEl.className = 'status-indicator status-' + status;
      }
      
      switch(status) {
        case 'local':
          if (statusEl) statusEl.textContent = 'üìÅ Local + File Backup';
          if (syncBtn) syncBtn.disabled = false;
          break;
        case 'syncing':
          if (statusEl) statusEl.textContent = 'üîÑ Syncing...';
          if (syncBtn) syncBtn.disabled = true;
          break;
        case 'synced':
          if (statusEl) statusEl.textContent = 'üìä Google Sheets';
          if (syncBtn) syncBtn.disabled = false;
          break;
        case 'offline':
          if (statusEl) statusEl.textContent = 'üìÅ Local + File Backup';
          if (syncBtn) syncBtn.disabled = false;
          break;
      }
    }

    async function syncWithDatabase() {
      try {
        const isAuthorized = gapi && gapi.client && gapi.client.getToken() !== null;
        
        if (!syncEnabled || !isAuthorized) {
          saveToLocalStorage();
          updateSyncStatus('local');
          
          const btn = document.getElementById('syncBtn');
          const originalText = btn.textContent;
          btn.textContent = 'Saved!';
          
          setTimeout(() => {
            btn.textContent = originalText;
            if (!isAuthorized) {
              alert('Authorize with Google to sync with Google Sheets, or use local storage with file export for backup.');
            } else {
              const shouldExport = confirm('Data saved locally. Would you like to export a backup file for true persistence?');
              if (shouldExport) {
                exportAllData();
              }
            }
          }, 2000);
          return;
        }
        
        console.log('üîÑ Starting database sync...');
        
        await saveSessionToSheets();
        
        const btn = document.getElementById('syncBtn');
        const originalText = btn.textContent;
        btn.textContent = 'Synced!';
        setTimeout(() => {
          btn.textContent = originalText;
        }, 2000);
        
      } catch (error) {
        console.error('‚ùå Sync failed:', error);
        alert('Sync failed: ' + error.message);
      }
    }

    async function autoSave() {
      try {
        const isAuthorized = gapi && gapi.client && gapi.client.getToken() !== null;
        if (syncEnabled && isAuthorized) {
          clearTimeout(window.autoSaveTimeout);
          window.autoSaveTimeout = setTimeout(async () => {
            await saveSessionToSheets();
          }, 2000);
        } else {
          saveToLocalStorage();
        }
      } catch (error) {
        console.error('Auto-save error:', error);
        saveToLocalStorage();
      }
    }

    // ===== APP INITIALIZATION =====
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ App starting ‚Äì waiting for Google APIs‚Ä¶');
      document.getElementById('connectionDetails').textContent = 'Waiting for Google APIs to load‚Ä¶';
      document.getElementById('authStatus').textContent = 'üîë Loading...';
      updateSyncStatus('offline');
      
      // fallback if Google APIs never load
      setTimeout(()=>{
        if (!gapiInited || !gisInited) {
          console.log('‚è∞ Google APIs timeout ‚Äì starting offline mode');
          document.getElementById('authStatus').textContent = '‚ùå Google APIs failed to load';
          startMyAppOffline();
        }
      }, 20000);
    });

    // ===== ONLINE/OFFLINE EVENTS =====
    window.addEventListener('online',  ()=>{ isOnline=true;  console.log('üì∂ Back online'); updateSyncStatus('local'); });
    window.addEventListener('offline', ()=>{ isOnline=false; console.log('üì¥ Offline');      updateSyncStatus('offline'); });

    // ===== AUTO-SAVE =====
    setInterval(()=>{
      try {
        const isAuthorized = gapi && gapi.client && gapi.client.getToken() !== null;
        if (syncEnabled && isAuthorized) autoSave();
        else saveToLocalStorage();
      } catch (error) {
        // If there's any error checking auth status, just use local storage
        saveToLocalStorage();
      }
    }, 60000);
  </script>
</body>
</html>
